---
lab:
  title: 'ラボ 08: 仮想マシンの管理'
  module: Administer Virtual Machines
---

# ラボ 08 - 仮想マシンを管理する

## ラボ概要

このラボでは、仮想マシンを作成し、仮想マシン スケール セットと比較します。 1 つの仮想マシンを作成、構成、サイズ変更する方法について説明します。 仮想マシン スケール セットを作成し、自動スケールを構成する方法について説明します。

## 推定時間:50 分

## ラボのシナリオ

あなたの組織では、Azure 仮想マシンのデプロイと構成を検討したいと考えています。 まず、手動スケーリングを使用して Azure 仮想マシンを実装します。 次に、仮想マシン スケール セットを実装し、自動スケールについて調べます。

## 実施するタスク

+ タスク 1: Azure portal を使用してゾーン回復性がある Azure 仮想マシンをデプロイする。
+ タスク 2: 仮想マシンのコンピューティングとストレージ スケーリングを管理する。
+ タスク 3: Azure Virtual Machine Scale Sets を作成して構成する。
+ タスク 4: Azure Virtual Machine Scale Sets をスケーリングする。
+ タスク 5:Azure PowerShell を使用して仮想マシンを作成する (オプション 1)。
+ タスク 6:CLI を使用して仮想マシンを作成する (オプション 2)。

## Azure Virtual Machines アーキテクチャ図

![VM アーキテクチャ タスクの図。](./media/az104-lab08-vm-architecture.png)

## タスク 1:Azure portal を使用してゾーン回復性がある Azure 仮想マシンをデプロイする

このタスクでは、Azure portal を使用して、2 つの Azure 仮想マシンを異なる可用性ゾーンにデプロイします。 可用性ゾーンは、仮想マシンのSLA を 99.99% で提供します。 この SLA を実現するには、少なくとも 2 つの仮想マシンを異なる可用性ゾーンにデプロイする必要があります。

1. [**Azure portal**](https://portal.azure.com) にサインインしてください。

1. **[仮想マシン]** ブレードで `Virtual machines` を検索して選択し、**[作成]** を検索してドロップダウンリストから **[Azure 仮想マシン]** を選択してください。

1. **[基本]** タブの **[可用性ゾーン]** ドロップダウンリストで、**[ゾーン 2]** の横にチェックマークを入力してください。 これにより、**ゾーン 1** と**ゾーン 2** の両方が選択されます。

    >**注**:これにより、選択したリージョンに 2 つの仮想マシンが、各ゾーンに 1 つずつデプロイされます。 少なくとも 2 つのゾーンに分散した少なくとも 2 つの VM があるため、99.99% のアップタイムの SLA を実現できます。 

1. [基本] タブで、引き続き構成を完了させます。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | MOC Subscription |
    | リソース グループ | **az104-rg8** から始まるリソースグループ |
    | 仮想マシン名 | `az104-vm1` と `az104-vm2` (両方の可用性ゾーンを選択した後、[仮想マシン名] フィールドの下にある **[名前の編集]** を選択してください)。 |
    | リージョン | **(US) East US** |
    | 可用性オプション | **可用性ゾーン** |
    | 可用性ゾーン | **ゾーン 1、2** |
    | セキュリティの種類 | **Standard** |
    | イメージ | **Windows Server 2019 Datacenter - x64 Gen2** |
    | Azure Spot 割引で実行する | 未選択 |
    | サイズ | **Standard D2s v3** |
    | ユーザー名 | `localadmin` |
    | パスワード | **任意のパスワードを指定する** |
    | パブリック受信ポート | **なし** |
    
1. **[次へ: ディスク]** を選択して、次の設定を指定してください (構成のレコメンデーションが出た場合は無視して進めます)。

    | 設定 | 値 |
    | --- | --- |
    | OS ディスクの種類 | **Premium SSD** |
    | VM と共に削除 | **チェック済み** (既定値) |
    | Ultra Disk の互換性を有効にする | 未選択                    |

1. **[次へ: ネットワーク]** 既定値を使用しますが、ロード バランサーは構成しないでください。

    | 設定 | Value |
    | --- | --- |
    | VM が削除されたときにパブリック IP とNIC を削除する | **オン** |
    | 負荷分散のオプション | **なし** |


1. **[次へ: 管理]** を選択し、次の設定を指定してください (他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | パッチ オーケストレーション オプション | **Azure調整済み** |

1. **[次へ: 監視]** を選択し、次の設定を指定してください (他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | ブート診断 | **無効化** |

1. **[次へ: 詳細]** を選択し、既定値を使用して、**[確認および作成]** を選択します。

1. 検証後に、**[作成]** を選択します。

    >**注:**  仮想マシンが NIC、ディスク、パブリック IP (構成されている場合) が個別に作成され、管理対象リソースをデプロイしていることに注目してください。

1. デプロイが完了するまで待ってから、**[リソースに移動]** を選択してください。


## タスク 2:仮想マシンのコンピューティングとストレージのスケーリングを管理する

このタスクでは、仮想マシンのサイズを別の SKU に調整することで、仮想マシンをスケーリングします。 Azure では、VM サイズの選択に柔軟性があるため、より多くの (またはより少ない) コンピューティングとメモリの割り当てが必要とされる場合、VM を一定期間調整することができます。 この概念はディスクに拡張され、ディスクのパフォーマンスを変更したり、割り当てられる容量を増やしたりすることができます。

1. **az104-vm1** 仮想マシンの **[可用性とスケール]** セクションで、**[サイズ]** を選択してください。

1. 仮想マシンのサイズを **DS1_v2** に設定し、**[サイズの変更]** を選択してください。 ダイアログが表示されたら、変更を確認してください。

    >**注**:**Standard DS1_v2** がない場合は、別のサイズを選択します。 サイズ変更は、垂直方向のスケーリング (拡大または縮小) とも呼ばれます。

1. **[設定]** セクションで **[ディスク]** を選択してください。

1. **[データ ディスク]** で **[新しいディスクを作成し接続する]** を選択してください。 設定を構成してください (他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | ディスク名 | `vm1-disk1` |
    | ストレージの種類 | **Standard HDD** |
    | サイズ (GiB) | `32` |

1. **[適用]** をクリックします。

1. ディスクが作成されたら、**[デタッチ]** (プラグを抜くようなアイコン)をクリックし、**[適用]** を選択してください。

    >**注**:デタッチすると、ディスクは VM から削除されますが、後で使用できるようにストレージ内に保持されます。

1. **[ディスク]** を検索して選択します。 ディスクの一覧から **vm1-disk1** オブジェクトを選択してください。

1. **[設定]** セクションから **[サイズおよびパフォーマンス]** を選択してください。

1. ストレージの種類を **Standard SSD** に設定し、**[保存]** を選択してください。

1. **az104-vm1** 仮想マシンに戻り、**[ディスク]** を選択してください。

1. **[データ ディスク]** セクションで、**[既存ディスクのアタッチ]** を選択します。

1. **[ディスク名]** ドロップダウンで、**[VM1-DISK1]** を選択します。 

1. ディスクが **Standard SSD** になっていることを確認してください。

1. **[適用]** を選択して変更を保存します。 

    >**注:**  これで、仮想マシンを作成し、SKU とデータ ディスク サイズをスケーリングしました。 次のタスクでは、Virtual Machine Scale Sets を使用してスケーリング プロセスを自動化します。

## Azure Virtual Machine Scale Sets アーキテクチャ図

![vmss アーキテクチャのタスクの図。](./media/az104-lab08-vmss-architecture.png)

## タスク 3:Azure Virtual Machine Scale Sets を作成して構成する

このタスクでは、可用性ゾーン間で Azure 仮想マシン スケール セットをデプロイします。 VM Scale Sets を使用すると、スケール セットを水平方向にスケーリング、スケールイン、またはスケールアウトできるようにするメトリックまたは条件を構成できるため、自動化の管理上のオーバーヘッドが削減されます。

1. Azure portal で `Virtual machine scale sets` を検索して選択し、**[Virtual Machine Scale Sets]** ブレードで、**[+作成]** を選択してください。

1. **[仮想マシン スケール セットの作成]** ブレードの **[基本]** タブで、次の設定を指定し (他の設定は既定値のままにします)、**[次: スポット]** を選択してください。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | MOC Subscription |
    | リソース グループ | **az104-rg8** から始まるリソースグループ |
    | 仮想マシン スケール セットの名前 | `vmss1` |
    | 地域 | **(US)East US** |
    | 可用性ゾーン | **ゾーン 1、2、3** |
    | オーケストレーション モード | **均一** |
    | セキュリティの種類 | **Standard** |
    | イメージ | **Windows Server 2019 Datacenter - x64 Gen2** |
    | Azure Spot 割引で実行する | **未選択** |
    | サイズ | **Standard D2s_v3** |
    | ユーザー名 | `localadmin` |
    | パスワード | **任意のパスワードを指定する**  |

    >**注**: Windows 仮想マシンの可用性ゾーンへのデプロイをサポートする Azure リージョンのリストについては、[Azure の Availability Zones の概要](https://docs.microsoft.com/en-us/azure/availability-zones/az-overview)に関するページを参照してください。

1. **[スポット]** タブで、既定値をそのまま使用し、**[次: ディスク]** をクリックします。

1. **[ディスク]** タブで、既定値をそのまま使用し、**[次:ネットワーク >]** を選択します。

1. **[ネットワーク]** ページで、**[仮想ネットワーク]** テキストボックスの下にある **[仮想ネットワークの作成]** リンクを選択し、次の設定で新しい仮想ネットワークを作成してください (他の仮想ネットワークは既定値のままにします)。  終わったら、 **[OK]** を選択します。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `vmss-vnet` |
    | アドレス範囲 | `10.82.0.0/20` (既定のアドレスから変更) |
    | サブネット名 | `subnet0` |
    | サブネット範囲 | `10.82.0.0/24` |

1. **[ネットワーク]** タブで、ネットワーク インターフェイス エントリの右側にある **[ネットワーク インターフェイスの編集]** (ペン状のアイコン)を選択してください。

1. **[NIC ネットワーク セキュリティ グループ]** セクションで、**[詳細]** を選択し、**[ネットワーク セキュリティ グループの構成]** で **[新規作成]** を選択してください。

1. **[ネットワーク セキュリティ グループの作成]** ブレードで、次の設定を指定します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **vmss1-nsg** |

1. **[受信規則の追加]** をクリックし、次の設定を使用して受信セキュリティ規則を追加します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | ソース | **Any** |
    | ソース ポート範囲 | * |
    | 宛先 | **Any** |
    | サービス | **HTTP** |
    | アクション | **許可** |
    | 優先度 | **1010** |
    | 名前 | `allow-http` |

1. **[追加]** をクリックし、**[ネットワーク セキュリティ グループの作成]** ブレードに戻って、**[OK]** をクリックします。

1. **[ネットワーク インターフェイスの編集]** ブレードの **[パブリック IP アドレス]** セクションで、**[有効]** を選択し、**[OK]** を選択してください。

1. **[ネットワーク]** タブの **[負荷分散]** セクションで、次を指定してください (他は既定値のままにします)。

     | 設定 | 値 |
     | --- | --- |
     | 負荷分散のオプション | **Azure Load Balancer** |
     | ロード バランサーを選択します | **ロード バランサーの作成** |

1. **[ロード バランサーの作成]** ページで、ロード バランサー名を指定し、既定値を使用します。 終了したら、 **[作成]** をクリックします。

     | 設定 | 値 |
     | --- | --- |
     | ロード バランサー名 | `vmss-lb` |

1. **[管理]** タブで、次の設定を指定してください (他は既定値のままにします)。

     | 設定 | 値 |
     | --- | --- |
     | ブート診断 | **無効化** |

1. ページの下部の **[次へ: 正常性]** を選択してください。

1. **[正常性]** タブで、変更を加えずに既定の設定を確認して **[次へ:詳細 >]** をクリックします。

1. **[詳細]** タブで、**[確認および作成]** を選択してください。

1. **[確認および作成]** タブで、検証に合格したことを確認し、**[作成]** を選択してください。

     >**注**:仮想マシン スケール セットのデプロイが完了するのを待ちます。 これには約 5 分かかります。

## タスク 4:Azure Virtual Machine Scale Sets をスケーリングする

このタスクでは、カスタム スケール ルールを使用して仮想マシン スケール セットをスケーリングします。

1. **[リソースに移動]** を選択するか、**vmss1** スケール セットを検索して選択してください。

1. スケール セット ウィンドウの左側のメニュー **[可用性とスケール]** セクションから **[スケーリング]** を選択します。

### スケールアウト ルール

1. **[カスタム自動スケーリング]** を選択します。 次に、**[スケール モード]** を **[メトリックに基づいてスケーリングする]** に変更してください。 次に、**[規則を追加する]** を選択してください。

1. VM インスタンスの数を自動的に増やすルールを作成しましょう。 このルールでは、10 分間の平均 CPU 負荷が 70% を超えるとスケールアウトされます。 ルールがトリガーされると、VM インスタンスの数が 20% 増加します。

    | 設定 | 値 |
    | --- | --- |
    | メトリックのソース | **現在のリソース (vmss1)** |
    | メトリック名前空間 | **仮想マシン ホスト** |
    | メトリックの名前 | **Percentage CPU** |
    | 演算子 | **次の値より大きい** |
    | スケール操作をトリガーするメトリックのしきい値 | **70** |
    | 期間 (分) | **10** |
    | 時間グレインの統計 | **平均** |
    | 操作 | **パーセントを増やす量** |
    | クールダウン (分) | **5** |
    | 割合 | **20** |

1. 設定を **[追加]** します。

### スケールイン ルール

1. 夜間や週末には需要が減少する場合があるため、スケールイン ルールを作成することが重要です。

1. スケール セット内の VM インスタンスの数を減らすルールを作成しましょう。 10 分間の平均 CPU 負荷が 30% を下回ると、インスタンスの数が減少します。 ルールがトリガーされると、VM インスタンスの数が 20% 減ります。

1. **[ルールの追加]** を選択し、設定を調整してから、**[追加]** を選択してください。

    | 設定 | 値 |
    | --- | --- |
    | 演算子 | **次の値より小さい** |
    | しきい値 | **30** |
    | 操作 | **パーセントを減らす量** |
    | 割合 | **20** |

1. 設定を **[追加]** します。

### インスタンスの制限を設定する

1. 自動スケーリング規則が適用される場合、インスタンスの制限により、インスタンスの最大数を超えてスケールアウトしたり、インスタンスの最小数を超えてスケールインしたりすることがなくなります。

1. **インスタンスの制限**は、ルールの後の **[スケーリング]** ページに表示されます。

    | 設定 | 値 |
    | --- | --- |
    | 最小値 | **2** |
    | 最大 | **10** |
    | 既定値 | **2** |

1. 変更を必ず**保存**してください

1. **vmss1** ページで、 **[インスタンス]** を選択してください。 ここでは、仮想マシン インスタンスの数を監視します。

    >**注:**  Azure PowerShell を使った仮想マシンの作成に関心がある方は、タスク 5 を試してください。 CLI を使用した仮想マシンの作成に関心がある方は、タスク 6 を試してください。

## タスク 5: Azure PowerShell (Option 1) を使用して仮想マシンを作成する

1. アイコン (右上) を使用して **Cloud Shell** セッションを起動してください。 または、`https://shell.azure.com` に直接移動してください。

1. 必ず **PowerShell** を選択してください。 必要に応じて、**[詳細設定の表示]** を使用し、シェル ストレージを構成してください。

1. 次のコマンドを入力して、仮想ネットワークを作成してください。 ダイアログが表示されたら、VM のユーザー名とパスワードを入力してください。 待機中に、仮想マシンの作成に関連付けられているすべてのパラメーターについて、[New-AzVM](https://learn.microsoft.com/powershell/module/az.compute/new-azvm?view=azps-11.1.0) コマンド リファレンスをチェックアウトしてください。

    > **注:**  "ResourceGroupName"に指定するリソースグループ名が異なる場合があります。Azure Portalで[リソースグループ]を検索して、使用可能なリソースグループ名を特定してください。またリージョン(-location)はリソースグループと同じリージョンを指定してください。下記は East US の場合です。

    ```powershell
    New-AzVm -ResourceGroupName 'az104-rg8' -Name 'myPSVM' -Image 'Win2019Datacenter' -location 'eastus' -Zone '1' -Size 'Standard_D2s_v3' -Credential (Get-Credential) 
    ```
    
1. コマンドが完了したら、**Get-AzVM** を使用してリソース グループ内の仮想マシンを一覧表示してください。

    ```powershell
    Get-AzVM -ResourceGroupName 'az104-rg8' -Status
    ```
    
1. 新しい仮想マシンが一覧表示され、**[状態]** が **[実行中]** になっていることを確認してください。

1. **Stop-AzVM** を使用して仮想マシンの割り当てを解除してください。 確認するには、「**Yes**」と入力してください。

    ```powershell
    Stop-AzVM -ResourceGroupName 'az104-rg8' -Name 'myPSVM' 
    ```
    
1. **Get-AzVM** を **-Status** パラメーターとともに使用して、マシンの**割り当てが解除されている**ことを確認してください。

## タスク 6:CLI を使用して仮想マシンを作成する (オプション 2)

1. アイコン (右上) を使用して **Cloud Shell** セッションを起動してください。 または、`https://shell.azure.com` に直接移動してください。

1. 必ず **[Bash]** を選択してください。 必要に応じて、**[詳細設定の表示]** を使用し、シェル ストレージを構成してください。

1. 次のコマンドを入力して、仮想ネットワークを作成してください。 ダイアログが表示されたら、VM のユーザー名とパスワードを入力してください。 待機中に、仮想マシンの作成に関連付けられているすべてのパラメーターについて、[az vm create](https://learn.microsoft.com/cli/azure/vm?view=azure-cli-latest#az-vm-create) コマンド リファレンスをチェックアウトしてください。

    > **注:**  "resource-group"に指定するリソースグループ名が異なる場合があります。Azure Portalで[リソースグループ]を検索して、使用可能なリソースグループ名を特定してください。またリージョン(--location)はリソースグループと同じリージョンを指定してください。下記は East US の場合です。

    ```sh
    az vm create --name myCLIVM --resource-group az104-rg8 --image Ubuntu2204 --size Standard_D2s_v3 --location eastus --admin-username localadmin --generate-ssh-keys
    ```

1. コマンドが完了したら、**az vm show** を使用してマシンが作成されたことを確認してください。

    ```sh
    az vm show --name  myCLIVM --resource-group az104-rg8 --show-details
    ```

1. **powerState** が **VM Running** であることを確認してください。

1. **az vm deallocate** を使用して仮想マシンの割り当てを解除してください。 確認するには、「**Yes**」と入力してください。

    ```sh
    az vm deallocate --resource-group az104-rg8 --name myCLIVM
    ```

1. **az vm show** を使用して、**powerState** が **VM deallocated** であることを確認してください。

    >**ご存知でしたか?** Azure を使用して仮想マシンを停止すると、状態が*割り当て解除*になります。 これは、静的でないパブリック IP が解放され、VM のコンピューティング コストの支払いを停止することを意味します。


## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。

+ Azure 仮想マシンは、オンデマンドでスケーラブルなコンピューティング リソースです。
+ Azure 仮想マシンには、垂直方向と水平方向の両方のスケーリング オプションが用意されています。
+ Azure 仮想マシンの構成には、オペレーティング システム、サイズ、ストレージ、ネットワーク設定の選択が含まれます。
+ Azure Virtual Machine Scale Sets では、負荷分散が行われる VM のグループを作成して管理することができます。
+ 仮想マシン スケール セット内の仮想マシンは、同じイメージと構成から作成されます。
+ 仮想マシン スケール セットでは、VM インスタンスの数は、需要または定義されたスケジュールに応じて自動的に増減できます。

## 自習トレーニングでさらに学習する

+ [Azure で Windows 仮想マシンを作成する](https://learn.microsoft.com/training/modules/create-windows-virtual-machine-in-azure/)。 Azure portal を使用して Windows 仮想マシンを作成します。 リモート デスクトップを使用して実行中の Windows 仮想マシンに接続する
+ [Virtual Machine Scale Sets を使用してスケーラブルなアプリケーションを構築する](https://learn.microsoft.com/training/modules/build-app-with-scale-sets/)。 Virtual Machine Scale Sets のコストを最小限に抑えながら、負荷の変化に合わせてアプリケーションを自動的に調整できるようにします。
+ [Azure Bastion を使用して Azure portal から仮想マシンに接続する](https://learn.microsoft.com/en-us/training/modules/connect-vm-with-azure-bastion/)。 Azure Bastion をデプロイして Azure portal 内で直接 Azure 仮想マシンに安全に接続して既存のジャンプボックス ソリューションを効果的に置き換え、診断ログを使用してリモート セッションを監視し、ユーザー セッションを切断してリモート セッションを管理します。
