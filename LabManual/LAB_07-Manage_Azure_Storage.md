---
lab:
  title: 'ラボ 07: Azure Storage を管理する'
  module: Administer Azure Storage
---

# ラボ 7 - Azure Storageを管理する

## ラボ概要

このラボでは、Azure BLOB と Azure ファイル用のストレージ アカウントを作成する方法について学習します。 BLOB コンテナーを構成してセキュリティで保護する方法について学習します。 ストレージ ブラウザーを使って、Azure ファイル共有を構成してセキュリティで保護する方法についても学習します。 

## 推定時間:50 分

## ラボのシナリオ

組織は現在、オンプレミスのデータ ストアにデータを格納しています。 これらのファイルのほとんどは頻繁にはアクセスされません。 アクセス頻度の低いファイルを低価格のストレージ層に配置することで、ストレージのコストを最小限に抑えることが考えられます。 ネットワーク アクセス、認証、認可、レプリケーションなど、Azure Storage が提供するさまざまな保護メカニズムについても検討する予定です。 最後に、Azure Files サービスがオンプレミスのファイル共有をホストするのにどの程度適しているかを判断する必要があります。

## アーキテクチャ図

![タスクの図。](./media/az104-lab07-architecture.png)

## 実施するタスク

+ タスク 1:ストレージ アカウントを作成して構成する。 
+ タスク 2:セキュリティで保護された BLOB ストレージを作成して構成する。
+ タスク 3:Azure File ストレージを作成して構成する。

## タスク 1:ストレージ アカウントを作成して構成する。 

このタスクでは、ストレージ アカウントを作成して構成します。 ストレージ アカウントは geo 冗長ストレージを使用し、パブリック アクセスはありません。 

1. [**Azure portal**](https://portal.azure.com) にサインインします。

1. `ストレージアカウント` を検索して選択し、**[+ 作成]** をクリックします。

1. **[ストレージ アカウントを作成する]** ブレードの **[基本]** タブで、次の設定を指定します (それ以外は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション          | MOC Subscription |
    | リソース グループ        | **az104-rg7** から始まるRG |
    | ストレージ アカウント名  | 英小文字と数字で構成される、長さが 3 から 24 のグローバルに一意の名前 |
    | リージョン                | **(US) East US** |
    | パフォーマンス           | **Standard** |
    | 冗長性            | **geo 冗長ストレージ** |
    | リージョンが利用できなくなった場合に、データへの読み取りアクセスを行えるようにします。 | 有効 |

1. **[詳細]** タブで、情報アイコンを使用して、選択肢の詳細を確認します。 既定値のままにします。 
1. **[ネットワーク]** タブで、使用可能なオプションを確認し、**[パブリック アクセスを無効にし、プライベート アクセスを使用する]** を選びます。
1. **[データ保護]** タブを確認します。7 日間が既定の論理的な削除アイテム保持ポリシーです。 BLOB のバージョン管理を有効にできます。 既定値を受け入れます。
1. **[暗号化]** タブを確認します。追加のセキュリティ オプションがあります。 既定値を受け入れます。
1. **[レビューと作成]** を選び、検証プロセスが完了するのを待ってから、**[作成]** をクリックします。
1. ストレージ アカウントがデプロイされたら、**[リソースに移動]** を選びます。
1. **[概要]** ブレードと、変更できる追加の構成があります。 これらはストレージ アカウントのグローバル設定です。 ストレージ アカウントは、BLOB コンテナー、ファイル共有、キュー、テーブルに使用できます。
1. **[セキュリティとネットワーク]** セクションで、**[ネットワーク]** を選択します。 パブリック ネットワーク アクセスが無効になっています。
    + **[パブリック ネットワーク アクセス]** を **[選択した仮想ネットワークと IP アドレスから有効]** に変更します。
    + **[ファイアウォール]** セクションで、**[クライアント IP アドレスの追加]** ボックスをオンにします。
    + 変更を**保存**します。 
1. **[データ管理]** セクションで、**[冗長性]** ブレードを表示します。 プライマリ データ センターとセカンダリ データ センターの場所に関する情報があります。
1. **[データ管理]** セクションで、**[ライフサイクル管理]** を選び、**[規則の追加]** を選びます。
    
    + 規則に `Movetocool` という名前を付けます。 規則の範囲を制限するオプションを確認します。
    
    + **[基本 BLOB]** タブで、基本 BLOB が最後に変更された時期が `30 days`前よりも古い "場合は"、**クール ストレージに移動します**。 
    
    + 詳細の確認が完了したら、**[追加]** を選びます。
    

## タスク 2:セキュリティで保護された BLOB ストレージを作成して構成する

このタスクでは、BLOB コンテナーを作成し、画像をアップロードします。 BLOB コンテナーは、非構造化データを格納するディレクトリに似た構造です。

### BLOB コンテナーと時間ベースのアイテム保持ポリシーを作成する

1. **[データ ストレージ]** セクションで、**[コンテナー]** をクリックします。 

1. **[+ コンテナー]** をクリックし、次の設定のコンテナーを**作成**します。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `data`  |
    | 匿名アクセス レベル | プライベート（匿名アクセスはありません） |

1. コンテナーで、右端にある省略記号 (...) までスクロールし、**[アクセス ポリシー]** を選びます。

1. **[不変 BLOB ストレージ]** セクションで、**[ポリシーの追加]** を選びます。

    | 設定 | 値 |
    | --- | --- |
    | ポリシーの種類 | **時間ベースの保持**  |
    | 保持期間の設定 | `180` 日 |

1. **[保存]** を選択します。

### BLOB のアップロードを管理する

1. [コンテナー] ページに戻り、**[data]** コンテナーを選び、**[↑アップロード]** をクリックします。

1. **[BLOB のアップロード]** ブレードで **[詳細設定]** セクションを展開します。

    >**注**:アップロードするファイルを見つけます。 これは任意の種類のファイルでかまいませんが、小さなファイルが最適です。 サンプル ファイルは AllFiles ディレクトリからダウンロードできます。 

    | 設定 | 値 |
    | --- | --- |
    | ファイルの参照 | アップロードするために選択したファイルを追加 |
    | BLOB の種類 | **ブロック BLOB** |
    | ブロック サイズ | **4 MiB** |
    | アクセス層 | **ホット** |
    | アップロード先のフォルダー | `securitytest` |
    | 暗号化スコープ | 既存の既定のコンテナー スコープを使用 |
    
1. **アップロード**をクリックします。

1. 新しいフォルダーがあることと、フォルダ内にファイルがアップロードされたことを確認します。 

1. アップロード ファイルを選択して、**[ダウンロード]**、**[削除]**、**[層の変更]**、**[リースの取得]** などのオプションを確認します。

1. ファイルの **[URL]** をコピーし、新しい **Inprivate** ブラウズ ウィンドウに貼り付けます。

1. **ResourceNotFound** または **PublicAccessNotPermitted** という XML 形式のメッセージが表示されます。

    > **注**: これは正常な動作であり、作成したコンテナーのパブリック アクセス レベルが **[非公開 (匿名アクセスなし)]** に設定されているためです。

### BLOB ストレージへの制限付きアクセスを構成する

1. アップロードしたファイルを選択した状態で、 **[SAS の生成]** タブを選びます。右端の省略記号 (...) を使用することもできます。 次の設定を指定します (それ以外は既定値のままにしておきます)。

    | 設定 | 値 |
    | --- | --- |
    | 署名キー | **キー 1** |
    | アクセス許可 | **読み取り** |
    | 開始日 | 昨日の日付 |
    | 開始時刻 | 現在時刻 |
    | 有効期限日 | 明日の日付 |
    | 有効期限 | 現在時刻 |
    | 使用できる IP アドレス | 空白のままにする |

1. **[SAS トークンおよび URL を生成]** をクリックします。

1. **BLOB SAS URL** エントリをクリップボードにコピーします。

1. 別の InPrivate ブラウザー ウィンドウを開き、前の手順でコピーした BLOB SAS URL にアクセスします。

    >**注**:ファイルの内容を表示できるはずです。 

## タスク 3:Azure Files ストレージを作成して構成する

このタスクでは、Azure Files 共有を作成して構成します。 ストレージ ブラウザーを使用してファイル共有を管理します。 

### ファイル共有を作成してファイルをアップロードする

1. ストレージ アカウントのブレードに戻り、**[データ ストレージ]** セクションで、**[ファイル共有]** をクリックします。

1. **[+ ファイル共有]** をクリックし、**[基本]** タブでファイル共有に `share1` という名前を付けます。 

1. **[アクセス層]** オプションを確認します。 既定の **[トランザクションが最適化されました]** のままにします。
   
1. **[バックアップ]** タブに移動し、**[バックアップの有効化]** をオフにします。 ラボの構成を簡素化するために、バックアップを無効にしています。

1. **[レビューと作成]** をクリックし、**[作成]** をクリックします。 ファイル共有がデプロイされるまで待ちます。

### ストレージ ブラウザーの詳細を確認し、ファイルをアップロードする

1. ストレージ アカウントに戻り、 **[ストレージ ブラウザー]** を選びます。 Azure ストレージ ブラウザーは、アカウントのすべてのストレージ サービスをすばやく表示できるポータル ツールです。

1. **[ファイル共有]** を選び、**share1** ディレクトリが存在することを確認します。

1. **share1** ディレクトリを選択すると、**[+ ディレクトリの追加]** を使用できることがわかります。 これを使用すると、フォルダー構造を作成できます。

1. **[アップロード]** を選択します。 任意のファイルを参照し、**[アップロード]** をクリックします。

    >**注**:ファイル共有を表示し、ストレージ ブラウザーでそれらの共有を管理できます。 現在、既知の制約はありません。

### ストレージ アカウントへのネットワーク アクセスを制限する

1. ポータルで、**[仮想ネットワーク]** を検索して選択します。

1. **[+ 作成]** を選択します。 リソース グループを選択します。 仮想ネットワークに `vnet1` という**名前**を付けます。

1. 他のパラメーターの既定値を使用して、**[レビューと作成]** を選択し、**[作成]** を選択します。

1. 仮想ネットワークのデプロイを待ってから、**[リソースに移動]** を選びます。

1. **[設定]** セクションで、**[サブネット]** ブレードを選択します。
    
    + **既定の**サブネットを選択します。
    
    + **[サービス エンドポイント]** セクションの **[サービス]** ドロップダウンで **Microsoft.Storage** を選択します。

    + 他の変更を加えないでください。    
    
    + 変更を必ず**保存**してください。
    
      > **注**:サブネットの編集から選択できない場合
      >
      > 仮想ネットワークの**［設定］**セクションで**［サービスエンドポイント］**ブレードを選択します。
      >
      > 追加のボタンをクリックし、**Microsoft.Storage**サービスと**既定**のサブネットを選択して追加することでも設定可能です。
    
1. ストレージ アカウントに戻ります。

1. **[セキュリティとネットワーク]** セクションで、**[ネットワーク]** ブレードを選択します。

1. **[既存の仮想ネットワークを追加する]** を選択し、**vnet1** と**既定の**サブネットを選び、**[追加]** を選びます。

1. **[ファイアウォール]** セクションで、マシンの IP アドレスを**削除**します。 許可されるトラフィックは、仮想ネットワークからの着信のみになるはずです。 

1. 変更を必ず**保存**してください。

    >**注:**  ストレージ アカウントにアクセスするのは、先ほど作成した仮想ネットワークからのみになるはずです。 

1. **[ストレージ ブラウザー]** を選択し、ページを**更新**します。 ファイル共有または BLOB コンテンツにアクセスします。  

    >**注:**  "この操作を行う権限がありません" というメッセージを受信するはずです。** 仮想ネットワークから接続していません。 これが有効になるには数分かかる場合があります。

## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。 

+ Azure ストレージ アカウントには、すべての Azure Storage データ オブジェクト (BLOB、ファイル、キュー、テーブル) が含まれます。 ストレージ アカウントでは、世界中のどこからでも HTTP または HTTPS 経由でアクセスできる Azure Storage データ用の一意の名前空間が提供されます。
+ Azure Storage には、ローカル冗長ストレージ (LRS)、ゾーン冗長ストレージ (ZRS)、geo 冗長ストレージ (GRS) などのいくつかの冗長性モデルが用意されています。 
+ Azure Blob ストレージを使用すると、Microsoft のデータ ストレージ プラットフォームに大量の非構造化データを格納できます。 BLOB とは Binary Large Object の略であり、画像やマルチメディア ファイルなどのオブジェクトが含まれます。
+ Azure File ストレージは、構造化データ用の共有ストレージを提供します。 データはフォルダーに整理できます。
+ 不変ストレージは、データを Write Once Read Many (WORM) 状態で格納する機能を提供します。 不変ストレージ ポリシーは、時間ベースまたは訴訟ホールドにできます。

## 自習トレーニングでさらに学習する

+ [Azure Blob Storage を使用してコストを最適化する](https://learn.microsoft.com/training/modules/optimize-your-cost-azure-blob-storage/)。 Azure Blob Storage を使用してコストを最適化する方法について学習します。
+ [Shared Access Signature を使用して Azure Storage へのアクセスを制御する](https://learn.microsoft.com/training/modules/control-access-to-azure-storage-with-sas/)。 Shared Access Signature を使用して、Azure Storage アカウントに格納されているデータへのアクセスを安全に許可します。
