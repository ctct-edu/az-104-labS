---
lab:
  title: 'ラボ 04: 仮想ネットワークを実装する'
  module: Implement Virtual Networking
---

# ラボ 04 - 仮想ネットワークを実装する

## ラボ概要

このラボでは、仮想ネットワークとサブネット化の基本について学習します。 ネットワークセキュリティグループとアプリケーションセキュリティグループを使用してネットワークを保護する方法について学びます。 また、DNSゾーンとレコードについても学びます。 

## 推定時間:50 分

## ラボのシナリオ 

あなたのグローバル組織では、仮想ネットワークの実装を計画しています。 当面の目標は、既存のすべてのリソースに対応することです。 ただし、組織は成長段階にあり、成長のための追加の容量を確保したいと考えています。

**CoreServicesVnet** 仮想ネットワークに最も多くのリソースを配置しています。 大きく成長することが見込まれるため、この仮想ネットワークには大きなアドレス空間が必要です。

**ManufacturingVnet** 仮想ネットワークには、製造施設の運用に使用するシステムが含まれます。 組織では、システムでのデータの取得元として、多数の内部接続デバイスを予想しています。 

## アーキテクチャ図

![ネットワークレイアウト](./media/az104-lab04-architecture.png)

これらの仮想ネットワークとサブネットは、既存のリソースに対応しながら、予想される成長にも対応できるような構造になっています。 これらの仮想ネットワークとサブネットを作成して、ネットワーク インフラストラクチャの基盤を構築してみましょう。

## 実施するタスク

+ タスク 1:ポータルを使用してサブネットを含む仮想ネットワークを作成する。
+ タスク 2:テンプレートを使用して仮想ネットワークとサブネットを作成する。
+ タスク 3:アプリケーション セキュリティグループとネットワークセキュリティグループの間の通信を作成して構成する。
+ タスク 4:パブリックとプライベートのAzure DNSゾーンを構成する。
  
## タスク 1:ポータルを使用してサブネットを含む仮想ネットワークを作成する

この組織では、中核サービスの大幅な成長を計画しています。 このタスクでは、既存のリソースと計画された成長に対応するように仮想ネットワークおよび関連するサブネットを作成します。 このタスクでは、Azure portal を使用します。 

1. [**Azure portal**](https://portal.azure.com) にサインインします。
   
1. **[仮想ネットワーク]** を検索して選択します。

1. 仮想ネットワーク ページで、**[作成]** を選択します。

1. CoreServicesVnet の **[基本]** タブに入力します。  

    |  **オプション**         | **Value**            |
    | ------------------ | -------------------- |
    | リソース グループ     | `az104-rg4` (新規作成) |
    | 仮想ネットワーク名       | `CoreServicesVnet`     |
    | 地域           | (US) **East US** |

1. **[IP アドレス]** タブに移動します。IPv4アドレス空間を**10.20.0.0/16**に設定します。

1. **+ サブネットの追加** を選択します。 各サブネットの名前とアドレスの情報を入力します。 サブネットごとに **[追加]** を選択します。 デフォルトのサブネットが設定されている場合は削除します。

    | **サブネット**             | **オプション**           | **Value**              |
    | ---------------------- | -------------------- | ---------------------- |
    | SharedServicesSubnet   | サブネット名          | `SharedServicesSubnet`   |
    |                        | 開始アドレス     | `10.20.10.0`          |
    |                        | サイズ                 | `/24` |
    | DatabaseSubnet         | サブネット名          | `DatabaseSubnet`         |
    |                        | 開始アドレス     | `10.20.20.0`        |
    |                        | サイズ                 | `/24` |

    >**注:**  どの仮想ネットワークにも少なくとも 1 つのサブネットが定義されている必要があります。 注意点として、5 つの IP アドレスが常に予約されます。 

1. CoreServicesVnet とサブネットの作成を終えるには、**[確認 + 作成]** を選択します。

1. 検証の完了後、**[作成]** を選択します。

1. 仮想ネットワークのデプロイを待ってから、**[リソースに移動]** を選択します。

1. **[オートメーション]** セクションで、**[テンプレートのエクスポート]** を選択し、テンプレートが生成されるまで待ちます。

1. テンプレートを**ダウンロード**します。

1. ローカル コンピューター上で、**ダウンロード** フォルダーに移動し、ダウンロードした ZIP ファイル内のファイルを**すべて展開**します。 

1. 展開したファイルに **template.json** ファイルがあることを確認してください。 このテンプレートを使用して、次のタスクで ManufacturingVnet を作成します。 

## タスク 2:テンプレートを使用して仮想ネットワークとサブネットを作成する

このタスクでは、ManufacturingVnet 仮想ネットワークと、関連付けられているサブネットを作成します。 組織は製造オフィスの増加を予測しているため、サブネットのサイズは予想される成長に合わせて調整されます。 このタスクでは、テンプレートを使用してリソースを作成します。 

1. 前のタスクで エクスポートした **template.json** ファイルを開きます。

1. 任意のエディターを使用してファイルを編集します。

### ManufacturingVnet 仮想ネットワークを作成する

1. **CoreServicesVnet** の出現箇所をすべて `ManufacturingVnet` に置換します。 

1. **10.20.0.0/16** の出現箇所を `10.30.0.0/16` に置換します。 

### ManufacturingVnet のサブネット用の変更を行う

1. **SharedServicesSubnet** の出現箇所をすべて `SensorSubnet1` に置換します。

1. **10.20.10.0/24** の出現箇所をすべて `10.30.20.0/24` に置換します。

1. **DatabaseSubnet** の出現箇所をすべて `SensorSubnet2` に置換します。

1. **10.20.20.0/24** の出現箇所をすべて `10.30.21.0/24` に置換します。

1. ファイルを読み返して、正しく変更されていることを確認します。

1. 変更を**保存** します。

### パラメーター ファイルに対して変更を行う

1. 前のタスクでエクスポートした **parameters.json** ファイルを見つけます。 **ダウンロード** フォルダーにあるはずです。

1. 任意のエディターを使用してファイルを編集します。

1. 1 つある **CoreServicesVnet** の出現箇所を `ManufacturingVnet` に置換します。

1. 変更内容を**保存**します。
   
### カスタム テンプレートをデプロイする

1. ポータルで、「**カスタム テンプレートのデプロイ**」を検索して選択します。

1. **[エディターで独自のテンプレートを作成する]**、**[ファイルの読み込み]** の順に選択します。

1. 製造に関する変更を含む **templates.json** ファイルを選択し、**[保存]** を選択します。

1. **[確認と作成]** 、 **[作成]** の順に選択します。

1. テンプレートがデプロイされるまで待ってから、ManufacturingVnetとサブネットが作成されたことを確認します。

## タスク 3:アプリケーション セキュリティ グループとネットワーク セキュリティ グループの間の通信を作成して構成する

このタスクでは、アプリケーション セキュリティ グループとネットワーク セキュリティ グループを作成します。 NSG には、ASG からのトラフィックを許可する受信セキュリティ規則を適用します。 また、NSG には、インターネットへのアクセスを拒否するアウトバウンド規則も適用します。 

### アプリケーション セキュリティ グループ (ASG) を作成する

1. Azure portal で、`アプリケーションのセキュリティグループ` を検索して選択します。

1. **[+作成]** をクリックし、基本情報を入力します。

    | 設定 | 値 |
    | -- | -- |
    | サブスクリプション | **MOC Subscription** |
    | リソース グループ | **az104-rg4** |
    | 名前 | `asg-web` |
    | リージョン | **East US** |

1. **[確認および作成]** をクリックし、検証後、**[作成]** をクリックします。

### ネットワーク セキュリティ グループを作成して ASG サブネットに関連付ける

1. Azure portal で、`ネットワークセキュリティグループ` を検索して選択します。

1. **[+ 作成]** を選択し、**[基本]** タブに情報を入力します。 

    | 設定 | 値 |
    | -- | -- |
    | サブスクリプション | **MOC Subscription** |
    | リソース グループ | **az104-rg4** |
    | 名前 | `myNSGSecure` |
    | リージョン | **East US** |

1. **[確認および作成]** をクリックし、検証後、**[作成]** をクリックします。

1. NSG がデプロイされたら、**[リソースに移動]** をクリックします。

1. **[設定]** セクションの **[サブネット]**、次に **[+ 関連付け]** をクリックします。

    | 設定 | 値 |
    | -- | -- |
    | 仮想ネットワーク | **CoreServicesVnet (az104-rg4)** |
    | Subnet | **SharedServicesSubnet** |

1. **[OK]** をクリックして関連付けを保存します。

### ASG トラフィックを許可する受信セキュリティ規則を構成する

1. NSG の作業を続行します。 **[設定]** セクションで、**[受信セキュリティ規則]** を選択します。

1. 既定の受信規則を確認します。 他の仮想ネットワークとロード バランサーのみがアクセスを許可されています。

1. **[+ 追加]** を選択します。

1. **[受信セキュリティ規則の追加]** ブレードで、次の情報を使用して受信ポート規則を追加します。 この規則では、ASG トラフィックが許可されます。 終わったら、**[追加]** を選択します。

    | 設定 | 値 |
    | -- | -- |
    | ソース | **Application security group** |
    | ソース アプリケーションのセキュリティ グループ | **asg-web** |
    | ソース ポート範囲 |  * |
    | 宛先 | **Any** |
    | サービス | **Custom** |
    | 宛先ポート範囲 | **80,443** |
    | プロトコル | **TCP** |
    | アクション | **許可** |
    | 優先度 | **100** |
    | 名前 | `AllowASG` |

### インターネット アクセスを拒否する送信 NSG 規則を構成する

1. 受信 NSG 規則を作成後、**[送信セキュリティ規則]** を選択します。 

1. **AllowInternetOutboundRule** 規則に注目してください。 また、この規則は削除できず、優先度が 65001 となっています。

1. **[+ 追加]** を選択し、インターネットへのアクセスを拒否するアウトバウンド規則を構成します。 終わったら、**[追加]** を選択します。

    | 設定 | 値 |
    | -- | -- |
    | ソース | **Any** |
    | ソース ポート範囲 |  * |
    | 宛先 | **Service Tag** |
    | 宛先サービス タグ | **Internet** |
    | サービス | **Custom** |
    | 宛先ポート範囲 | **8080** |
    | プロトコル | **Any** |
    | アクション | **拒否** |
    | 優先順位 | **4096** |
    | 名前 | **DenyAnyCustom8080Outbound** |


## タスク 4:パブリックとプライベートの Azure DNS ゾーンを構成する

このタスクでは、パブリックとプライベートの DNS ゾーンを作成して構成します。 

### パブリック DNS ゾーンを構成する

1. ポータルで、`DNS ゾーン` を検索して選択します。

1. **[+ 作成]** を選択します。

1. **[基本]** タブを構成します。
    ドメイン名は[**GoDaddy**](https://jp.godaddy.com/)で未使用のドメインを検索して使用します。

    | プロパティ | 値    |
    |:---------|:---------|
    | サブスクリプション | **MOC Subscription** |
    | リソース グループ | **az04-rg4** |
    | 名前 | 使用されていない任意のドメイン名称 |
    | リソース グループの場所 |**East US** |

1. **[レビュー作成]**、**[作成]** の順に選択します。

1. DNS ゾーンのデプロイを待ってから、**[リソースに移動]** を選択します。

1. **[概要]** ブレードで、ゾーンに割り当てられている 4 つの Azure DNS ネーム サーバーの名前を確認します。 ネーム サーバーのアドレスのいずれかを**コピー**します。 後の手順で必要になります。 

1. **[+ レコード セット]** を選択します。 以下の値を設定します。

    | 設定        | 値                        |
    | ----------- | ------------------------- |
    | 名前        | **www**                   |
    | 種類        | **A - アドレス レコード** |
    | TTL         | **1**                     |
    | IP アドレス | **10.1.1.4**              |

1. **[OK]** を選択し、**www** という名前の A レコード セットがあることを確認します。

1. コマンド プロンプトを開いて、次のコマンドを実行します。
    <name server name>には、以前のタスクで確認したネームサーバーのアドレスを入力します。

    ```sh
    nslookup www.contoso.com <name server name>
    ```

1. 指定した IP アドレスに解決されることを確認します。 これにより、名前解決が正常に機能していることを確認します。

### プライベート DNS ゾーンを構成する

プライベート DNS ゾーンは、仮想ネットワーク内の名前解決サービスを提供します。 プライベート DNS ゾーンは、リンクされている仮想ネットワークからのみアクセスでき、インターネットからアクセスすることはできません。 

1. ポータルで、`プライベートDNSゾーン` を検索して選択します。

1. **[+ 作成]** を選択します。

1. [プライベート DNS ゾーンの作成] の **[基本]** タブで、次の表に示すように情報を入力します。

    | プロパティ | 値    |
    |:---------|:---------|
    | サブスクリプション | **MOC Subscription** |
    | リソース グループ | **az04-rg4** |
    | 名前 | `private.contoso.com` |
    | リソースグループの場所 |**East US** |

1. **[レビュー作成]**、**[作成]** の順に選択します。
   
1. DNS ゾーンのデプロイを待ってから、**[リソースに移動]** を選択します。

1. **[概要]** ブレードにネーム サーバー レコードがないことに注意してください。 

1. **[+ 仮想ネットワーク リンク]** を選択し、**[+ 追加]** を選択します。 

    | プロパティ | 値    |
    |:---------|:---------|
    | リンク名 | `manufacturing-link` |
    | 仮想ネットワーク | `ManufacturingVnet` |

1. **[OK]** を選択し、リンクが作成されるまで待ちます。 

1. **[概要]** ブレードで、**[+ レコード セット]** を選択します。 ここで、プライベート名前解決のサポートが必要な仮想マシンごとにレコードを追加します。

    | プロパティ | 値    |
    |:---------|:---------|
    | 名前 | **sensorvm** |
    | Type | **A** |
    | TTL | **1** |
    | IP アドレス | **10.1.1.4** |

## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。 

+ 仮想ネットワークとは、クラウド内のユーザー独自のネットワークを表したものです。 
+ 仮想ネットワークを設計するときは、IP アドレス範囲が重複しないようにすることをお勧めします。 そうすることで問題が減り、トラブルシューティングが簡略化されます。
+ サブネットとは、仮想ネットワーク内の IP アドレスの範囲です。 仮想ネットワークは、整理とセキュリティのために複数のサブネットに分割できます。
+ ネットワーク セキュリティ グループには、ネットワーク トラフィックを許可または拒否するセキュリティ規則が含まれています。 受信と送信の既定の規則があり、ニーズに合わせてカスタマイズできます。
+ アプリケーション セキュリティ グループは、Web サーバーやデータベース サーバーなど、共通の機能を持つサーバーのグループを保護するために使用されます。
+ Azure DNS は DNS ドメインのホスティング サービスであり、名前解決を提供します。 パブリック ドメイン内のホスト名を解決するように Azure DNS を構成できます。  また、プライベート DNS ゾーンを使用して、Azure 仮想ネットワーク内の仮想マシン (VM) に DNS 名を割り当てることもできます。

## 自習トレーニングでさらに学習する

+ [Azure 仮想ネットワークの概要](https://learn.microsoft.com/training/modules/introduction-to-azure-virtual-networks/)。 仮想ネットワーク、パブリック IP とプライベート IP、DNS、仮想ネットワーク ピアリング、ルーティング、Azure Virtual NAT など、主な Azure ネットワーク リインフラストラクチャを設計して実装します。
+ [IP アドレス指定スキームを設計する](https://learn.microsoft.com/training/modules/design-ip-addressing-for-azure/)。 Azure およびオンプレミスの仮想ネットワークのプライベートとパブリックの IP アドレス指定機能を明らかにします。
+ [ネットワーク セキュリティ グループとサービス エンドポイントを使うことで Azure リソースへのアクセスをセキュリティで保護し、分離する](https://learn.microsoft.com/training/modules/secure-and-isolate-with-nsg-and-service-endpoints/)。 ネットワーク セキュリティ グループとサービス エンドポイントを使って、自分の仮想マシンと Azure サービスを未承認のネットワーク アクセスからセキュリティで保護することができます。
+ [Azure DNS でドメインをホストする](https://learn.microsoft.com/training/modules/host-domain-azure-dns/)。 ドメイン名の DNS ゾーンを作成します。 DNS レコードを作成し、ドメインを IP アドレスにマップします。 ドメイン名が Web サーバーに解決されることをテストします。

