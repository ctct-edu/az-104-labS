---
lab:
  title: 'ラボ 05: サイト間接続を実装する'
  module: Administer Intersite Connectivity
---

# ラボ 05 - サイト間の接続性を実装する

## ラボ概要

このラボでは、仮想ネットワーク間の通信について確認します。 仮想ネットワーク ピアリングを実装して、接続をテストします。 カスタム ルートも作成します。 

## 推定時間:50 分

## ラボのシナリオ 

組織では、主要な IT アプリとサービス (DNS やセキュリティ サービスなど) を、製造部署を含むビジネスの他の部分からセグメント化します。 ただし、一部のシナリオでは、主要な領域内のアプリとサービスが製造領域内のアプリやサービスと通信する必要があります。 このラボでは、セグメント化された領域間の接続性を構成します。 これは、運用を開発から分離したり、ある子会社を別の子会社から分離したりする一般的なシナリオです。  

## アーキテクチャ図

![ラボ 05 アーキテクチャ ダイアグラム](./media/az104-lab05-architecture.png)

## 実施するタスク

+ タスク 1:仮想ネットワーク内で仮想マシンを作成する。
+ タスク 2:別の仮想ネットワーク内に仮想マシンを作成する。
+ タスク 3:Network Watcher を使用して仮想マシン間の接続をテストする。 
+ タスク 4:別の仮想ネットワーク間で仮想ネットワーク ピアリングを構成する。
+ タスク 5:Azure PowerShell を使用して仮想マシン間の接続をテストする。
+ タスク 6: カスタム ルートを作成する。 

## タスク 1:主要サービスの仮想マシンと仮想ネットワークを作成する

このタスクでは、仮想マシンと主要サービスの仮想ネットワークを作成します。 

1. [**Azure portal**](https://portal.azure.com) にサインインします。

1. `Virtual Machines` を検索して選択します。

1. [Virtual Machines] ブレードで、**[+作成]** → **[Azure 仮想マシン]** を選択します。

1. [基本] タブ上で、次の情報を使用してフォームに入力し、**[次: ディスク >]** をクリックします。 指定されていない設定項目は、既定値のままにしてください。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **MOC Subscription** |
    | リソース グループ | `az104-rg5` |
    | 仮想マシン名 |    `CoreServicesVM` |
    | 地域 | **(US) East US** |
    | 可用性オプション | インフラストラクチャ冗長は必要ありません |
    | セキュリティの種類 | **Standard** |
    | イメージ | **Windows Server 2019 Datacenter - x64 Gen2** |
    | サイズ | **Standard_D2s_v3** |
    | ユーザー名 | `localadmin` |
    | パスワード | **任意のパスワードを指定** |
    | パブリック受信ポート | **なし** |

1. **[ディスク]** タブ上で既定値のまま、**[次:ネットワーク >]** を選択します。

1. **[ネットワーク]** タブ上の [仮想ネットワーク] で、**[新規作成]** を選択します。

1. 次の情報を使用して仮想ネットワークを構成し、**[OK]** を選択します。 必要に応じて、既存の情報を削除または置換します。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `CoreServicesVNet` (新規作成) |
    | アドレス範囲 | `10.0.0.0/16`  |
    | サブネット名 | `Core` |
    | サブネットのアドレス範囲 | `10.0.0.0/24` |

1. **[監視]** タブを選択します。[ブート診断] で、**[無効化]** を選択します。

1. **[確認および作成]**、**[作成]** の順に選択します。

1. リソースが作成されるまで待つ必要はありません。 次のタスクに進みます。


## タスク 2:別の仮想ネットワーク内に仮想マシンを作成する

このタスクでは、仮想マシンと製造サービスの仮想ネットワークを作成します。 

1. Azure portal から、「**Virtual Machines**」を検索して選択します。

1. [Virtual Machines] ページで、**[作成]** を選択し、**[Azure 仮想マシン]** を選択します。

1. [基本] タブ上で、次の情報を使用してフォームに入力し、**[次へ: ディスク >]** をクリックします。 指定されていない設定は、既定値のままにしてください。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **MOC Subscription** |
    | リソース グループ |  `az104-rg5` |
    | 仮想マシン名 |    `ManufacturingVM` |
    | 地域 | **(US) East US** |
    | セキュリティの種類 | **Standard** |
    | 可用性オプション | インフラストラクチャ冗長は必要ありません |
    | イメージ | **Windows Server 2019 Datacenter - x64 Gen2** |
    | サイズ | **Standard_D2s_v3** |
    | ユーザー名 | `localadmin` |
    | パスワード | **任意のパスワードを指定** |
    | パブリック受信ポート | **なし** |

1. **[ディスク]** タブ上で既定値のまま、**[次:ネットワーク >]** を選択します。

1. [ネットワーク] タブ上の [仮想ネットワーク] で、**[新規作成]** を選択します。

1. 次の情報を使用して仮想ネットワークを構成し、**[OK]** を選択します。  必要に応じて、既存のアドレス範囲を削除または置換します。

    | 設定 | 値 | 
    | --- | --- |
    | 名前 | `ManufacturingVNet` |
    | アドレス範囲 | `172.16.0.0/16`  |
    | サブネット名 | `Manufacturing` |
    | サブネットのアドレス範囲 | `172.16.0.0/24` |

1. **[監視]** タブを選択します。[ブート診断] で、**[無効化]** を選択します。

1. **[確認および作成]**、**[作成]** の順に選択します。

## タスク 3:Network Watcher を使用して仮想マシン間の接続をテストする 


このタスクでは、ピアリングされた仮想ネットワーク内のリソースが相互に通信できることを確認します。 Network Watcher は、その接続をテストするために使用します。 続行する前に、両方の仮想マシンがデプロイ済みで、実行されていることをご確認ください。 

1. Azure portal から、`Network Watcher` を検索して選択します。

1. [Network Watcher] の [ネットワーク診断ツール] セクションで、**[接続のトラブルシューティング]** を選択します。

1. 次の情報を使用して、**[接続のトラブルシューティング]** ブレード上のフィールドに入力します。

    | フィールド | 値 |
    | --- | --- |
    | 送信元の種類           | **仮想マシン**   |
    | 仮想マシン       | **CoreServicesVM**    |
    | 宛先の種類 | **仮想マシンの選択** |
    | 仮想マシン       | **ManufacturingVM**   |
    | 優先 IP バージョン  | **両方**              |
    | プロトコル         | **TCP**               |
    | 宛先ポート      | `3389`                |
    | 送信元ポート           | *空白*         |
    | 診断テスト      | 接続, NSG診断, ネクストホップ, ポートスキャナー |

1. **[診断テストを実行する]** を選択してください。
    ここでは接続テストに失敗しますが、想定された動作です。この後のタスクで接続可能になるよう設定します。


## タスク 4:仮想ネットワーク間で仮想ネットワーク ピアリングを構成する

このタスクでは、仮想ネットワーク ピアリングを作成して、仮想ネットワーク内のリソース間での通信を有効にします。 

1. Azure portal 内で、仮想ネットワークを検索して選択します。一覧からCoreServicesVnetを選択します。

1. CoreServicesVnet の **[設定]** セクションから、**[ピアリング]** を選択します。

1. [CoreServicesVnet |ピアリング] で、**[+ 追加]** を選択します。

1. 次の表の情報を使用して、ピアリングを作成します。

| **パラメーター**                                    | **Value**                             |
| --------------------------------------------- | ------------------------------------- |
| **この仮想ネットワーク**                                       |                                       |
| ピアリング リンク名                             | `CoreServicesVnet-to-ManufacturingVnet` |
| ピアリングされた仮想ネットワーク へのアクセスを許可する | 選択 (既定値)                       |
| ピアリングされた仮想ネットワーク からのトラフィック転送の受信を 'CoreServicesVNet' に許可する | 選択                       |
| ゲートウェイまたはルート サーバーに ピアリングされた仮想ネットワーク へのトラフィックの転送を許可する | 未選択 (既定値) |
| ピアリングされた仮想ネットワーク のリモート ゲートウェイまたはルート サーバーを使用する | 未選択 (既定値)                        |
| **リモート仮想ネットワーク**                                   |                                       |
| ピアリング リンク名                   | `ManufacturingVnet-to-CoreServicesVnet` |
| 仮想ネットワークのデプロイ モデル              | **Resource Manager**                 |
| リソース ID を知っている                         | 未選択                       |
| サブスクリプション                                  | **MOC Subscription** |
| 仮想ネットワーク                               | **ManufacturingVnet**                     |
| ’ManufacturingVnet’ へのアクセスを許可する  | 選択 (既定値)                       |
| ピアリングされた仮想ネットワーク からのトラフィック転送の受信を ’ManufacturingVnet’ に許可する | 選択                        |
| ゲートウェイまたはルート サーバーに ピアリングされた仮想ネットワーク へのトラフィックの転送を許可する | 未選択 (既定値) |
| ピアリングされた仮想ネットワーク のリモート ゲートウェイまたはルート サーバーを使用する | 未選択 (既定値)                        |

1. 設定を確認し、**[追加]** を選択します。

1. [CoreServicesVnet | ピアリング] で、**CoreServicesVnet-to-ManufacturingVnet** ピアリングが一覧に表示されることを確認します。 ページを更新して、**[ピアリング状態]** が **[接続済み]** であることを確認します。

1. **[ManufacturingVnet]** に切り替えて、**[ManufacturingVnet-to-CoreServicesVnet]** のピアリングが一覧に表示されることを確認します。 **[ピアリング状態]** が **[接続済み]** であることを確認します。 ページを**更新**する必要がある場合があります。 


## タスク 5:Azure PowerShell を使用して仮想マシン間の接続をテストする

このタスクでは、別の仮想ネットワーク内で仮想マシン間の接続を再テストします。 

### CoreServicesVM のプライベート IP アドレスを確認する

1. Azure portal から、「`CoreServicesVM`」仮想マシンを検索して選択します。

1. **[概要]** ブレード上の **[ネットワーク]** セクション内で、そのマシンの **[プライベート IP アドレス]** を記録します。 接続をテストするには、この情報が必要です。
   
### **ManufacturingVM** から CoreServicesVM への接続をテストする

1. `ManufacturingVM` 仮想マシンに切り替えます。

1. **[操作]** セクション内で、**[実行コマンド]** を選択します。

1. **[RunPowerShellScript]** を選択し、「**Test-NetConnection**」コマンドを実行します。 必ず **CoreServicesVM** のプライベート IP アドレスを使用してください。

    ```Powershell
    Test-NetConnection <CoreServicesVM private IP address> -port 3389
    ```
1. スクリプトがタイムアウトするまでに数分かかる場合があります。ページの上部には "スクリプトを実行しています" の情報メッセージが表示されます。

1. ピアリングは構成済みのため、このテスト接続は成功するはずです。
   

## タスク 6:カスタム ルートを作成する 

このタスクでは、境界サブネットと内部の主要サービスのサブネット間のネットワーク トラフィックを制御します。 仮想ネットワーク アプライアンスが主要サービスのサブネット内にインストールされ、すべてのトラフィックをそこにルーティングする必要があります。 

1. 仮想ネットワークのブレードで「`CoreServicesVnet`」を選択します。

1. **[サブネット]** → **[+ 作成]** を選択します。 以下の表の設定を入力して **保存**してください。 

    | 設定 | 値 | 
    | --- | --- |
    | 名前 | `perimeter` |
    | サブネットのアドレス範囲 | `10.0.1.0/24`  |


1. Azure portal 内で、「`ルートテーブル`」を検索して選択し、**[+作成]** を選択します。 
    以下の表の設定を入力して、**[確認と作成]** → **[作成]** と進んでルートテーブルをデプロイします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | MOC Subscription |
    | リソース グループ | `az104-rg5`  |
    | リージョン | **East US** |
    | 名前 | `rt-CoreServices` |
    | ゲートウェイのルートを伝達する | **No** |

1. ルート テーブルがデプロイされたら、**[リソースに移動]** を選択します。

1. **[設定]** セクションから **[ルート]** → **[+ 追加]** を選択します。CoreServices 仮想ネットワークのルートを作成します。 

    | 設定 | 値 |
    | --- | --- |
    | ルート名 | `PerimetertoCore` |
    | 宛先の種類 | **IP アドレス** |
    | 宛先 IP アドレス/CIDR 範囲 | `10.0.0.0/16` |
    | ネクストホップの種類 | **仮想アプライアンス** |
    | ネクスト ホップ アドレス | `10.0.1.7` |

1. ルートの設定が完了したら **[+ 追加]** を選択します。 最後に、そのルートをサブネットに関連付けます。

1. **[設定]** セクションから **[サブネット]** → **[関連付け]** を選択します。 構成を完了します。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **CoreServicesVnet** |
    | サブネット | **Core** |


## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。 

+ 既定では、別の仮想ネットワーク内のリソースは通信することができません。
+ Azure の 2 つ以上の仮想ネットワークにシームレスに接続するには、仮想ネットワーク ピアリングを使用できます。
+ ピアリングされた仮想ネットワークは、接続性において 1 つのネットワークとして表示されます。
+ ピアリングされた仮想ネットワーク内の仮想マシン間のトラフィックには、Microsoft のバックボーンインフラストラクチャが使用されます。
+ システム定義ルートは、仮想ネットワーク内のサブネットごとに自動的に作成されます。 ユーザー定義ルートは、既定のシステム ルートをオーバーライドする、または追加されます。 
+ Azure Network Watcher には、Azure IaaS リソースのメトリックとログを監視、診断、表示する一連のツールが用意されています。

## 自習トレーニングでさらに学習する

+ [Azure 仮想ネットワーク全体にサービスを分散させ、仮想ネットワーク ピアリングを使用して統合する](https://learn.microsoft.com/en-us/training/modules/integrate-vnets-with-vnet-peering/)。 仮想ネットワーク ピアリングを使用し、セキュリティで保護され、複雑さを最小限に抑えた方法により、仮想ネットワーク間で通信できるようにします。
+ [ルートを使用して Azure デプロイでのトラフィック フローを管理および制御する](https://learn.microsoft.com/training/modules/control-network-traffic-flow-with-routes/)。 カスタム ルートを実装して Azure 仮想ネットワークのトラフィックを制御する方法について学習します。
