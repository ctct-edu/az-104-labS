---
lab:
  title: 'ラボ 06: トラフィック管理を導入する'
  module: Administer Network Traffic Management
---

# ラボ 06 - トラフィック管理を実装する

## ラボ概要

このラボでは、パブリック ロード バランサーとアプリケーション ゲートウェイを構成してテストする方法について学習します。

## 推定時間:50 分

## ラボのシナリオ

この組織にはパブリック Web サイトがあります。 着信したパブリック要求を、異なる仮想マシン間に負荷分散させる必要があります。 また、異なる仮想マシンから画像とビデオを提供する必要もあります。 Azure Load Balancer と Azure Application Gateway の実装を計画します。 すべてのリソースは同じリージョンにあります。

## 実施するタスク

+ タスク 1:テンプレートを使用してインフラストラクチャをプロビジョニングします。
+ タスク 2:Azure Load Balancer を構成する。
+ タスク 3:Azure Application Gateway を構成する。

## タスク 1:テンプレートを使用してインフラストラクチャをプロビジョニングする

このタスクでは、テンプレートを使って、1 つの仮想ネットワーク、1 つのネットワーク セキュリティ グループ、2 つの仮想マシンをデプロイします。

1. [**Azure portal**](https://portal.azure.com) にサインインします。

1. `カスタムテンプレートのデプロイ` を検索して選択します。

1. [カスタム デプロイ] ブレードで、**[エディターで独自のテンプレートを作成する]** を選択します。

1. [テンプレートの編集] ブレードで、**[ファイルの読み込み]** を選択します。

1. **\\Allfiles\\Lab06\\az104-06-vms-template.json** ファイルを見つけて選び、**[開く]** を選びます。

1. **[保存]** を選択します。

1. **[パラメーターの編集]** を選んで、**\\Allfiles\\Lab06\\az104-06-vms-parameters.json** ファイルを読み込みます。

1. **[保存]** を選択します。

1. 次の情報を使って、カスタム デプロイ ページのフィールドを設定します。他のフィールドはすべて既定値のままにします。

    | 設定       | 値         |
    | ---           | ---           |
    | サブスクリプション  | MOC Subscription |
    | リソースグループ | az104-rg6 |
    | Admin Password | 任意のパスワードを指定する<br />※12 から 123 文字の間<br />  小文字、大文字、数字、記号の内3つ以上を含む |

1. **[確認と作成]** を選択し、次に **[作成]** を選択します。

    >**注**:デプロイが完了するまで待ってから、次のタスクに進んでください。 デプロイには約 5 分かかります。

    >**注**:デプロイされているリソースを確認してください。 3 つのサブネットを含む 1 つの仮想ネットワークがあります。 サブネットごとに仮想マシンがあります。

## タスク 2:Azure Load Balancer を構成する

このタスクでは、仮想ネットワーク内の 2 つの Azure 仮想マシンの前面に Azure Load Balancer を実装します。 Azure のロード バランサーは、仮想マシンなどのリソース間にレイヤー 4 の接続を提供します。 Load Balancer の構成には、接続を受け入れるフロントエンド IP アドレス、バックエンド プール、接続がロード バランサーを通過する方法を定義する規則が含まれます。

## アーキテクチャ図 - Load Balancer

![ラボ タスクの図。](./media/az104-lab06-lb-architecture.png)

1. Azure portal で「`ロードバランサー`」を検索して選び、**[ロード バランサー]** ブレードで **[+ 作成]** をクリックします。

1. 次の設定でロード バランサーを作成し (他の設定は既定値のままにします)、**[次へ: フロントエンド IP 構成]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | MOC Subscription |
    | リソースグループ | **az104-rg6** |
    | 名前 | `az104-lb` |
    | 地域 | East US |
    | SKU  | **Standard** |
    | 種類 | **パブリック** |
    | レベル | **地域** |

1. **[フロントエンド IP 構成]** タブで、 **[+フロントエンド IP 構成の追加]** をクリックし、次の設定を使用します。  

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-fe` |
    | IPの種類 | IP アドレス |
    | パブリック IP アドレス | **[新規作成]** |
    | ゲートウェイロードバランサー | なし |

1. **[パブリック IP アドレスの追加]** ポップアップで、次の設定を使用してから **[保存]** 、 フロントエンドIP構成の追加に戻り **[保存]** の順にクリックします。 完了したら、 **[次へ: バックエンド プール]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-lbpip` |
    | SKU | Standard |
    | レベル | 地域 |
    | 割り当て | 静的 |
    | ルーティングの優先順位 | **Microsoft ネットワーク** |

    >**注:**  Standard SKU では静的 IP アドレスが提供されます。 静的 IP アドレスは、リソースの作成時に割り当てられて、リソースの削除時に解放されます。  

1. **[バックエンド プール]** タブで、次の設定を使って **[バックエンド プールの追加]** をクリックして以下の表の設定を適用します。VMの追加が完了したら、 **[保存]** をクリックしてから、**[次へ: インバウンド規則]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-be` |
    | 仮想ネットワーク | **az104-06-vnet1** |
    | バックエンド プールの構成 | **NIC** |
    | **[追加]** をクリックして仮想マシンを追加します |  |
    | az104-06-vm0 | **チェックボックスをオンにします** |
    | az104-06-vm1 | **チェックボックスをオンにします** |

1. 時間があれば、他のタブも確認してから、 **[確認および作成]** をクリックします。 検証エラーがないことを確認し、 **[作成]** をクリックします。

1. ロード バランサーがデプロイされるまで待ってから、 **[リソースに移動]** をクリックします。

**着信トラフィックの分散方法を決定する規則を追加する**

1. ロードバランサーブレードで **[設定]** セクションから **[負荷分散規則]** を選びます。

1. **[+追加]** を選択します。 次の設定で負荷分散規則を追加します (その他は既定値のままにします)。  規則を構成するときは、情報アイコンを使って各設定について確認します。 終わったら、**[保存]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-lbrule` |
    | IP バージョン | **IPv4** |
    | フロントエンド IP アドレス | **az104-fe** |
    | バックエンド プール | **az104-be** |
    | プロトコル | **TCP** |
    | ポート | `80` |
    | バックエンド ポート | `80` |
    | 正常性プローブ | **新規作成** |
    | 名前(正常性プローブ) | `az104-hp` |
    | プロトコル(正常性プローブ) | **TCP** |
    | ポート(正常性プローブ) | `80` |
    | 間隔(正常性プローブ) | `5` |
    | セッション永続化 | **なし** |
    | アイドル タイムアウト (分) | `4` |
    | TCP リセット | **無効** |
    | フローティング IP | **無効** |
    | アウトバウンドの送信元ネットワーク アドレス変換 (SNAT) | **推奨** |
    
1.  **[設定]** セクションで **[フロントエンド IP 構成]** を選びます。 パブリック IP アドレスをコピーします。

1. 別のブラウザー タブを開き、その IP アドレスに移動します。 ブラウザー ウィンドウに、"**Hello World from az104-06-vm0**" または "**Hello World from az104-06-vm1**" というメッセージが表示されることを確認します。

1. ウィンドウを更新して、メッセージが他の仮想マシンに変更されることを確認します。 これは、ロード バランサーが仮想マシンを交代させていることを示しています。

    > **注**: 複数回更新するか、InPrivate モードで新しいブラウザー ウィンドウを開く必要がある場合があります。

## タスク 3:Azure Application Gateway を構成する

このタスクでは、2 台の Azure 仮想マシンの前面に Azure Application Gateway を実装します。 Application Gateway では、レイヤー 7 の負荷分散、Web Application Firewall (WAF)、SSLエンドポイント、バックエンド プールで定義されているリソースへのエンド ツー エンドの暗号化が提供されます。 このアプリケーション ゲートウェイは、画像を 1 つの仮想マシンにルーティングし、ビデオをもう 1 つの仮想マシンにルーティングします。

## アーキテクチャ図 - Application Gateway

>**注**:このアプリケーション ゲートウェイは、ロード バランサーと同じ仮想ネットワークで動作しています。 これは、運用環境では一般的ではないことがあります。

![ラボ タスクの図。](./media/az104-lab06-gw-architecture.png)

1. Azure portal で、`仮想ネットワーク` を検索して選びます。

1. **[仮想ネットワーク]** ブレードの仮想ネットワークの一覧で、**[az104-06-vnet1]** をクリックします。

1. **[az104-06-vnet1]** 仮想ネットワーク ブレードの **[設定]** セクションで、**[サブネット]** をクリックしてから、**[+ サブネット]** をクリックします。

1. 次の設定でサブネットを追加します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `subnet-appgw` |
    | サブネットアドレス範囲 | `10.60.3.224/27` |

1. Azure portal で「`アプリケーションゲートウェイ`」を検索して選び、**[アプリケーション ゲートウェイ]** ブレードで **[+ 作成]** をクリックします。

1. **[基本]** タブで、次の設定を指定します (他の設定は既定値のままにしておきます)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | MOC Subscription |
    | リソースグループ | `az104-rg6` |
    | アプリケーション ゲートウェイ名 | `az104-appgw` |
    | 地域 | East US |
    | レベル | **Standard V2** |
    | 自動スケール | **いいえ** |
    | インスタンス数 | `2` |
    | 可用性ゾーン | **ゾーン 1** |
    | HTTP2 | **無効** |
    | 仮想ネットワーク | **az104-06-vnet1** |
    | サブネット | **subnet-appgw (10.60.3.224/27)** |

1. **[次へ: フロントエンド >]** をクリックし、次の設定を指定します (その他は既定値のままにします)。 設定が完了したら **[OK]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | フロントエンド IPの種類 | **パブリック** |
    | パブリック IPv4 アドレス | **[新規追加]** |
    | 名前 | `az104-gwpip` |
    | 可用性ゾーン | **1** |

    >**注:**  Application Gateway は、パブリックとプライベート両方の IP アドレスを持つことができます。

1. **[次へ: バックエンド >]** をクリックし、 **[バックエンド プールの追加]** をクリックします。 次の設定を指定します (他の設定は既定値のままにしておきます)。 完了したら、 **[追加]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-appgwbe` |
    | ターゲットを持たないバックエンド プールを追加します | **いいえ** |
    | 仮想マシン | **az104-rg6-nic1 (10.60.1.4)** |
    | 仮想マシン | **az104-rg6-nic2 (10.60.2.4)** |

1. **[バックエンド プールの追加]** をクリックします。 これは、**画像**のためのバックエンド プールです。 次の設定を指定します (他の設定は既定値のままにしておきます)。 完了したら、 **[追加]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-imagebe` |
    | ターゲットを持たないバックエンド プールを追加します | **いいえ** |
    | 仮想マシン | **az104-rg6-nic1 (10.60.1.4)** |

1. **[バックエンド プールの追加]** をクリックします。 これは、**ビデオ**のためのバックエンド プールです。 次の設定を指定します (他の設定は既定値のままにしておきます)。 完了したら、 **[追加]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | `az104-videobe` |
    | ターゲットを持たないバックエンド プールを追加します | **いいえ** |
    | 仮想マシン | **az104-rg6-nic2 (10.60.2.4)** |

1. **[次へ: 構成]** を選んでから、**[ルーティング規則の追加]** を選びます。 情報を設定します。

    | 設定 | 値 |
    | --- | --- |
    | ルール名 | `az104-gwrule` |
    | 優先度 | `10` |
    | リスナー名 | `az104-listener` |
    | フロントエンド IP | **パブリックIPv4** |
    | プロトコル | **HTTP** |
    | ポート | `80` |
    | リスナーの種類 | **Basic** |

1. **[バックエンド ターゲット]** タブに移動します。基本情報を入力します。

   | 設定 | 値 |
   | --- | --- |
   | バックエンド ターゲット | `az104-appgwbe` |
   | バックエンド設定名 | `az104-http` (新規作成) |

1. **[パスベースの規則を作成する複数のターゲットを追加します]** を選びます。 2 つの規則を作ります。 それぞれの設定を入力して **[追加]** をクリックします。 

    **規則 - 画像バックエンドへのルーティング**

    | 設定 | Value |
    | --- | --- |
    | パス | `/image/*` |
    | ターゲット名 | `images` |
    | バックエンド設定 | **az104-http** |
    | バックエンド ターゲット | `az104-imagebe` |

    **規則 - ビデオ バックエンドへのルーティング**

    | 設定 | Value |
    | --- | --- |
    | パス | `/video/*` |
    | ターゲット名 | `videos` |
    | バックエンド設定 | **az104-http** |
    | バックエンド ターゲット | `az104-videobe` |

1. ルーティング規則の追加ページで**[追加]**をクリックして、**[次へ:タグ >]** を選択できます。 変更は不要です。

1. **[次へ: 確認および作成 >]**、**[作成]** の順にクリックします。

    > **注**:Application Gateway インスタンスが作成されるのを待ちます。 これには約 5 から 10 分かかります。

1. Application Gateway がデプロイされたら、**az104-appgw** を検索して選びます。

1. **Application Gateway** リソースの **[監視]** セクションで、**[バックエンド正常性]** を選びます。

1. バックエンド プールの両方のサーバーが **[正常]** と表示されていることを確認します。

1. **[概要]** ブレードで、**[フロントエンド パブリック IP アドレス]** の値をコピーします。

1. 別のブラウザー ウィンドウを開始して、URL `http://<frontend ip address>/image/` をテストします。

1. 画像サーバー (vm1) に転送されることを確認します。

1. 別のブラウザー ウィンドウを開始して、URL `http://<frontend ip address>/video/` をテストします。

1. ビデオ サーバー (vm2) に転送されることを確認します。

> **注**: 複数回更新するか、InPrivate モードで新しいブラウザー ウィンドウを開く必要がある場合があります。

## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。

+ Azure Load Balancer は、トランスポート層 (OSI 階層 4 - TCP と UDP) で複数の仮想マシンにネットワーク トラフィックを分散させるための優れた選択肢です。
+ パブリック ロード バランサーは、インターネット トラフィックを VM に負荷分散する目的で使用されます。 内部 (プライベート) ロード バランサー は、フロントエンドのみでプライベート IP が必要な場合に使用されます。
+ Basic Load Balancer は、高可用性や冗長性を必要としない小規模なアプリケーション向けです。 Standard Load Balancer は、ハイ パフォーマンスで超低遅延のためのものです。
+ Azure Application Gateway は、Web アプリケーションに対するトラフィックを管理できる Web トラフィック (OSI レイヤー 7) ロード バランサーです。
+ Application Gateway の Standard レベルでは、負荷分散を含むすべての L7 機能が提供されます。WAF 層では、悪意のあるトラフィックを調べるためのファイアウォールが追加されます。
+ Application Gateway は、URI パスやホスト ヘッダーなど、HTTP 要求の追加属性に基づいて、ルーティングの決定を行うことができます。

## 自習トレーニングでさらに学習する

+ [Azure Load Balancer を使用してアプリケーションのスケーラビリティと回復性を向上させる](https://learn.microsoft.com/training/modules/improve-app-scalability-resiliency-with-load-balancer/)。 Azure のさまざまなロード バランサーと、ご自身の要件を満たすために適切な Azure Load Balancer ソリューションを選択する方法について説明します。
+ [Application Gateway で Web サービスのトラフィックを負荷分散する](https://learn.microsoft.com/training/modules/load-balance-web-traffic-with-application-gateway/)。 複数のサーバーに負荷を分散し、パスベースのルーティングを使って Web トラフィックを転送することにより、アプリケーションの回復性を向上させます。
