---
lab:
    title: '06 - トラフィック管理を実装する'
    module: 'モジュール 06 - ネットワーク トラフィック管理'
---

# ラボ 06 - トラフィック管理を実装する
# 受講生用ラボ マニュアル

## ラボ シナリオ

オンプレミスにおけるハブアンドスポーク型のネットワーク トポロジで、仮想マシンを対象としたネットワーク トラフィックの管理テストを担当していましたが、Contoso は Azure 環境での実装を検討しています。これは前のラボでテストしたメッシュ トポロジを代替するものとして計画されています。このテストでは、ハブを経由してトラフィックを強制的に流すユーザー定義ルートを作成してスポーク間の接続を実装する必要があります。また、レイヤ 4 およびレイヤ 7 ロード バランサーを使用して仮想マシン間でのトラフィック分散を行う必要があります。この目的のために、Azure Load Balancer (レイヤ 4) と Azure Application Gateway (レイヤ 7) を使用する予定です。

## 目標

このラボでは次の内容を学習します。

+ タスク 1: ラボ環境をプロビジョニングする
+ タスク 2: ハブとスポークのネットワーク トポロジを構成する
+ タスク 3: 仮想ネットワーク ピアリングの推移性をテストする
+ タスク 4: ハブアンドスポークのトポロジのルーティングを構成する
+ タスク 5: Azure Load Balancer を実装する
+ タスク 6: Azure Application Gateway を実装する

## 推定時間: 60 分

## アーキテクチャ

![イメージ](./media/lab06.png)


## 手順

### 演習 1

#### タスク 1: ラボ環境をプロビジョニングする

このタスクでは、同じ Azure リージョンに 4 つの仮想マシンをデプロイします。最初の 2 つはハブ仮想ネットワークに存在し、残りはそれぞれ別個のスポーク仮想ネットワークに存在します。

1. [Azure portal](https://portal.azure.com/) にサインインします。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。

    > **注**: **Cloud Shell** の初回起動時に **「ストレージがマウントされていません」** というメッセージが表示された場合は、**「ストレージの作成」** を選択します。約1～2分ほどで、ストレージアカウントが作成され、コマンド入力することが可能になります。

1. Cloud Shell ウィンドウのツールバーで、**「ファイルのアップロード/ダウンロード」** アイコンをクリックし、ドロップダウン メニューで 

    **「アップロード」** をクリックして、以下のファイルをファイルをCloud Shell ホーム ディレクトリにアップロードします。

    　　　**\Allfiles\Labs\06\az104-06-vms-loop-template.json** 

    　　　 **\Allfiles\Labs\06\az104-06-vms-loop-parameters.json**

1. 「Cloud Shell」 ペインから次を実行して、ラボ環境をホストする最初のリソース グループを作成します。

    ```powershell
    $location = 'eastus'
    
    $rgName = 'az104-06-rg1'
    
    New-AzResourceGroup -Name $rgName -Location $location
    ```

1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行します。アップロードしたテンプレートとパラメーター ファイルを使用して、 3 つの仮想ネットワークと4 つの Azure VM を作成します。パスワードの入力を求められるため、任意のパスワードを入力します。

    > **注:** VMのパスワードには要件が設けられています。以下の条件を満たすように設定する必要があります。<br>
    > ・8 文字以上 256 文字以下<br>
    > ・次の 4 種類の文字のうち 3 つが必要です。<br>
    > 	英小文字<br>
    > 	英大文字<br>
    > 	数値(0 から 9)<br>
    > 	記号<br>

    ```powershell
    New-AzResourceGroupDeployment `
       -ResourceGroupName $rgName `
       -TemplateFile $HOME/az104-06-vms-loop-template.json `
       -TemplateParameterFile $HOME/az104-06-vms-loop-parameters.json
    ```

1. Cloud Shell ウィンドウから以下を実行して、前の手順でデプロイされた Azure VM に Network Watcher 拡張機能をインストールします。

    ```powershell
    $rgName = 'az104-06-rg1'
    $location = (Get-AzResourceGroup -ResourceGroupName $rgName).location
    $vmNames = (Get-AzVM -ResourceGroupName $rgName).Name
    
    foreach ($vmName in $vmNames) {
      Set-AzVMExtension `
      -ResourceGroupName $rgName `
      -Location $location `
      -VMName $vmName `
      -Name 'networkWatcherAgent' `
      -Publisher 'Microsoft.Azure.NetworkWatcher' `
      -Type 'NetworkWatcherAgentWindows' `
      -TypeHandlerVersion '1.4'
    }
    ```

1. 設定完了後、「Cloud Shell」 ペインを閉じます。

#### タスク 2: ハブアンドスポークのネットワーク トポロジを構成する

このタスクでは、前のタスクで展開した仮想ネットワーク間のローカル ピアリングを構成して、ハブアンドスポークのネットワーク トポロジを作成します。

1. Azure portal で、**「仮想ネットワーク」** を検索して選択します。

1. 前のタスクで作成した仮想ネットワークを確認します。

    >**注**: デプロイされた3つのバーチャルネットワークは、それぞれのIP アドレス範囲が重複しないようにテンプレートが設計されています。

1. 仮想ネットワークのリストで、**「az104-06-vnet2」** を選択します。

1. 「**az104-06-vnet2**」 ブレードで「**設定**」セクションから「**プロパティ**」を選択します。 

1. 「**az104-06-vnet2 \| プロパティ**」ブレードで、「**リソース ID**」プロパティの値を記録します。

1. 仮想ネットワークのリストに戻り、**「az104-06-vnet3」** を選択します。

1. 「**az104-06-vnet3**」ブレードで「**設定**」セクションから「**プロパティ**」を選択します。 

1. 「**az104-06-vnet3 \| プロパティ**」ブレードで、「**リソース ID**」プロパティの値を記録します。

    >**注**: このタスクの後半で、各仮想ネットワークのリソースIDが必要になります。
    >仮想ネットワーク ピアリングを作成するときに、Azure Portal が新しくプロビジョニングされた仮想ネットワークを表示しないことがあるため、その回避策として実施しています。

1. 仮想ネットワークのリストで、**「az104-06-vnet01」** をクリックします。

1. **「az104-06-vnet01** 仮想ネットワーク」ブレードの **「設定」** セクションで **「ピアリング」** をクリックしてから、**「+ 追加」** をクリックします。

1. 次の設定でピアリングを追加し (指定のない項目は既定値のままにする)、**「追加」** をクリックします。

      | 設定                                                         | 値                                                           |
      | ------------------------------------------------------------ | ------------------------------------------------------------ |
      | **この仮想ネットワーク**：ピアリング リンク名                | **az104-06-vnet01_to_az104-06-vnet2**                        |
      | **この仮想ネットワーク**：リモート仮想ネットワークへのトラフィック | **許可（規定）**                                             |
      | **この仮想ネットワーク**：リモート仮想ネットワークから転送されたトラフィック | **この仮想ネットワークの外部から来ているトラフィックをブロックする** |
      | **この仮想ネットワーク**：仮想ネットワーク ゲートウェイまたはルート サーバー | **なし**                                                     |
      | **リモート仮想ネットワーク**：ピアリング リンク名            | **az104-06-vnet2_to_az104-06-vnet01**                        |
      | **リモート仮想ネットワーク**：仮想ネットワークのデプロイ モデル | **Resource Manager**                                         |
      | リソース ID を知っている                                     | **チェックボックスにチェックを入れる**                       |
      | リソース ID                                                  | このタスクの前半で記録した **az104-06-vnet2** のリソースID   |
      | リモート 仮想ネットワークのトラフィック                      | **許可 (既定)**                                              |
      | リモート 仮想ネットワークから転送されたトラフィック          | **許可 (既定)**                                              |
      | 仮想ネットワーク ゲートウェイ                                | **なし (既定)**                                              |

      >**注**: 操作が完了するまで待ちます。

      >**注**: この手順では、az104-06-vnet01 から az104-06-vnet2、az104-06-vnet2 から az104-06-vnet01 までの 2 つのローカル ピアリングを確立します。

1. **「az104-06-vnet01** 仮想ネットワーク」ブレードの **「設定」** セクションで **「ピアリング」** をクリックしてから、**「+ 追加」** をクリックします。

1. 次の設定でピアリングを追加し (指定のない項目は既定値のままにする)、**「追加」** をクリックします。

     | 設定                                                         | 値                                                           |
     | ------------------------------------------------------------ | ------------------------------------------------------------ |
     | **この仮想ネットワーク**：ピアリング リンク名                | **az104-06-vnet01_to_az104-06-vnet3**                        |
     | **この仮想ネットワーク**：リモート仮想ネットワークへのトラフィック | **許可（規定）**                                             |
     | **この仮想ネットワーク**：リモート仮想ネットワークから転送されたトラフィック | **この仮想ネットワークの外部から来ているトラフィックをブロックする** |
     | **この仮想ネットワーク**：仮想ネットワーク ゲートウェイまたはルート サーバー | **なし**                                                     |
     | **リモート仮想ネットワーク**：ピアリング リンク名            | **az104-06-vnet3_to_az104-06-vnet01**                        |
     | **リモート仮想ネットワーク**：仮想ネットワークのデプロイ モデル | **Resource Manager**                                         |
     | リソース ID を知っている                                     | **チェックボックスにチェックを入れる**                       |
     | リソース ID                                                  | このタスクの前半で記録した **az104-06-vnet3** のリソースID   |
     | リモート 仮想ネットワークのトラフィック                      | **許可 (既定)**                                              |
     | リモート 仮想ネットワークから転送されたトラフィック          | **許可 (既定)**                                              |
     | 仮想ネットワーク ゲートウェイ                                | **なし (既定)**                                              |

     > **注**: この手順では、az104-06-vnet01 から az104-06-vnet3、az104-06-vnet3 から az104-06-vnet01 までの 2 つのローカル ピアリングを確立します。これで、ハブとスポーク トポロジの設定が完了します (2 つのスポーク仮想ネットワークを使用)。

#### タスク 3: 仮想ネットワーク ピアリングの推移性をテストする

このタスクでは、Network Watcher を使用して仮想ネットワーク ピアリングの推移性をテストします。

1. Azure portal で、**「Network Watcher」** を検索して選択します。

1. **「Network Watcher」** ブレードで、Azure リージョンのリストを展開し、このラボの最初のタスクでリソースをデプロイした Azure でサービスが有効になっていることを確認します。

1. **「Network Watcher」** ブレードで、**「接続のトラブルシューティング」** に移動します。

1. **「Network Watcher | 接続のトラブルシューティング」** ブレードで、次の設定でチェックを開始します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ | **az104-06-rg1** |
    | ソースの種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm0** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、IP アドレスのいずれか | **10.62.0.4** |
    | プロトコル | **TCP** |
    | 宛先のポート | **3389** |

    > **注**: **10.62.0.4** は、プライベート IP アドレス **az104-06-vm2** を表します。

1. **「診断テストの実行」** をクリックし、接続チェックの結果が返されるまで待ちます。状態が **「到達可能」** であることを確認します。ネットワーク パスを確認し、VM 間に中間ホップのない直接接続であることを確認します。

    > **注**: ハブ仮想ネットワークは最初のスポーク仮想ネットワークと直接ピアリングされるため問題なく接続されています。

1. 「**Network Watcher - 接続のトラブルシューティング**」ブレードで、次の設定でチェックを開始します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ | **az104-06-rg1** |
    | ソースの種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm0** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、IP アドレスのいずれか | **10.63.0.4** |
    | プロトコル | **TCP** |
    | 宛先のポート | **3389** |

    > **注**: **10.63.0.4** は、プライベート IP アドレス **az104-06-vm3** を表します。

1. 「**診断テストの実行**」をクリックし、接続チェックの結果が返されるまで待ちます。状態が「**到達可能**」であることを確認します。ネットワーク パスを確認し、VM 間に中間ホップのない直接接続であることを確認します。

    > **注**: ハブ仮想ネットワークは 2 番目のスポーク仮想ネットワークと直接ピアリングされるため、問題なく接続されています。

1. 「**Network Watcher - 接続のトラブルシューティング**」ブレードで、次の設定でチェックを開始します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ | **az104-06-rg1** |
    | ソースの種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm2** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、IP アドレスのいずれか | **10.63.0.4** |
    | プロトコル | **TCP** |
    | 宛先のポート | **3389** |

1. 「**診断テストの実行**」をクリックし、接続チェックの結果が返されるまで待ちます。ステータスが「**到達不能**」であることを確認してください。

    > **注**: これは、2 つのスポーク仮想ネットワークが互いにピアリングされないので、 実質的に接続はされていません(仮想ネットワーク ピアリングは推移的ではありません)。

#### タスク 4: ハブアンドスポークのトポロジのルーティングを構成する

このタスクでは、**az104-06-vm0** 仮想マシンのネットワーク インターフェイスで IP 転送を有効にし、OSの機能でルーティングを有効にします。また、スポーク仮想ネットワーク上でユーザー定義ルートを構成することにより、2 つのスポーク仮想ネットワーク間でのルーティングを構成およびテストします。

1. Azure portal で、「**Virtual Machines**」を検索して選択します。

1. 「**Virtual Machines**」ブレードの仮想マシンのリストで、「**az104-06-vm0**」 をクリックします。

1. 「**az104-06-vm0** 仮想マシン」 ブレードの「**設定**」セクションで、「**ネットワーク**」をクリックします。

1. 「**ネットワーク インターフェイス**」ラベルの横の 「**az104-06-nic0**」 リンクをクリックし、「**az104-06-nic0**」 ネットワーク インターフェイス ブレードの「**設定**」セクションで 「**IP 構成**」をクリックします。

1. 「**IP 転送を有効にする**」 のチェックボックスを 「**オン**」 に設定し、「**適用**」をクリックして変更を保存します。

   > **注**: この設定は、2 つのスポーク仮想ネットワーク間でトラフィックをルーティングするルーターとして **az104-06-vm0** が機能するために必要です。
   > ルーティングをサポートするように **az104-06-vm0** 仮想マシンのオペレーティング システムを構成する必要があります。
   
1. 上記手順1.および2.の要領で、「**az104-06-vm0** Azure 仮想マシン」 ブレードに戻ります。

1. **az104-06-vm0** ブレードの 「**操作**」 セクションで、「**実行コマンド**」 をクリックし、コマンドのリストで **RunPowerShellScript** を選択します。

1. 「**実行コマンド スクリプト**」 ブレードで、次のコマンドを入力し、「**実行**」 をクリックしてリモート アクセス Windows サーバー ロールをインストールします。

   ```powershell
   Install-WindowsFeature RemoteAccess -IncludeManagementTools
   ```

   > **注**: コマンドが正常に完了したことを確認します。

1. 「**実行コマンド スクリプト**」ブレードで、次のコマンドを入力し、「**実行**」 をクリックしてルーティング ロール サービスをインストールします。

   ```powershell
   Install-WindowsFeature -Name Routing -IncludeManagementTools -IncludeAllSubFeature

   Install-WindowsFeature -Name "RSAT-RemoteAccess-Powershell"

   Install-RemoteAccess -VpnType RoutingOnly

   Get-NetAdapter | Set-NetIPInterface -Forwarding Enabled
   ```

   > **注**: コマンドが正常に完了したことを確認します。

   > **注**: 次に、スポーク仮想ネットワーク上でユーザー定義のルートを作成および構成する必要があります。

1. Azure portal で 「**ルート テーブル**」 を検索して選択し、「**ルート テーブル**」 ブレードで 「**+ 作成**」 をクリックします。

1. 次の設定でルート テーブルを作成します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ | **az104-06-rg1** |
    | リージョン | **East US** |
    | 名前 | **az104-06-rt23** |
    | ゲートウェイのルートを伝達する | **No** |

1. **「確認および作成」** をクリックします。検証の完了後、**「作成」** をクリックしてデプロイを実行します。

   > **注**: 新しいルーティング テーブルが作成されるのを待ちます。通常は 3 分ほどかかります。

1. 「**リソースに移動**」をクリックします。

1. 「**az104-06-rt23** ルート テーブル」 ブレードの 「**設定**」 セクションで 「**ルート**」 をクリックしてから、「**+ 追加**」 をクリックします。

1. 次の設定で新しいルートを追加する:

      | 設定 | 値 |
      | --- | --- |
      | ルート名 | **az104-06-route-vnet2-to-vnet3** |
      | アドレス プレフィックス 送信先 | **IP アドレス** |
      | 宛先IPアドレス/CIDR範囲 | **10.63.0.0/20** |
      | ネクストホップの種類 | **仮想アプライアンス** |
      | ネクストホップアドレス | **10.60.0.4** |

1. 「**追加**」 をクリックします

1. 「**az104-06-rt23** ルート テーブル」 ブレードの 「**設定**」 セクションで 「**サブネット**」 をクリックしてから、「**+ 関連付け**」 をクリックします。

1. ルート テーブル 「**az104-06-rt23**」 を次のサブネットに関連付けます。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **az104-06-vnet2** |
    | サブネット | **subnet0** |

1. 「**OK**」 をクリックします

1. 「**ルート テーブル**」 ブレードに戻り、「**+ 作成**」 をクリックします。

1. 次の設定でルート テーブルを作成します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション             | **既定のサブスクリプション** |
    | リソース グループ              | **az104-06-rg1**                 |
    | リージョン                     | **East US**                      |
    | 名前                           | **az104-06-rt32**                |
    | ゲートウェイのルートを伝達する | **No**                           |

1. 「確認と作成」 をクリックします。検証の完了後、「作成」 をクリックしてデプロイを実行します。

   > **注**: 新しいルーティング テーブルが作成されるのを待ちます。通常は 3 分ほどかかります。

1. 「**リソースに移動**」をクリックします。

1. 「**az104-06-rt32** ルート テーブル」 ブレードの 「**設定**」 セクションで 「**ルート**」 をクリックしてから、「**+ 追加**」 をクリックします。

1. 次の設定で新しいルートを追加する:

     | 設定 | 値 |
     | --- | --- |
     | ルート名 | **az104-06-route-vnet3-to-vnet2** |
     | アドレス プレフィックス 送信先 | **IPアドレス** |
     | 宛先IPアドレス/CIDR範囲 | **10.62.0.0/20** |
     | ネクストホップの種類     | **仮想アプライアンス**            |
     | ネクストホップアドレス | **10.60.0.4** |

1. 「**追加**」 をクリックします

1. 「**az104-06-rt32** ルート テーブル」 ブレードの 「**設定**」 セクションで 「**サブネット**」 をクリックしてから、「**+ 関連付け**」 をクリックします。

1. ルート テーブル 「**az104-06-rt32**」 を次のサブネットに関連付けます。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **az104-06-vnet3** |
    | サブネット | **subnet0** |

1. 「**OK**」 をクリックします

1. Azure portal で、「**Network Watcher - 接続トラブルシューティング**」 ブレードに戻ります。

1. 「**Network Watcher - 接続のトラブルシューティング**」 ブレードで、次の設定でチェックを開始します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ | **az104-06-rg1** |
    | ソースの種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm2** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、IP アドレスのいずれか | **10.63.0.4** |
    | プロトコル | **TCP** |
    | 宛先のポート | **3389** |

1. 「**診断テストの実行**」 をクリックし、接続チェックの結果が返されるまで待ちます。状態が 「**到達可能**」 であることを確認します。ネットワーク パスを確認し、トラフィックが **az104-06-nic0** ネットワーク アダプターに割り当てられた **10.60.0.4** を経由してルーティングされたことを確認します。ステータスが**到達不能**の場合は、az104-06-vm0 を再起動する必要があります。

    > **注**: スポーク仮想ネットワーク間のトラフィックは、ルーターとして機能するハブ仮想ネットワークにある仮想マシンを経由してルーティングされるため、以前とは異なり接続された状態となります。
    > **Network Watcher** を使用して、ネットワークのトポロジを表示することもできます。
    

#### タスク 5: Azure Load Balancer を実装する

このタスクでは、ハブ仮想ネットワーク内の 2 つの Azure 仮想マシンの前に Azure Load Balancer を実装します。

1. Azure portal で 「**ロード バランサー**」 を検索して選択し、「**ロード バランサー**」 ブレードで 「**+ 作成**」 をクリックします。

1. 「**基本**」タブで、次の設定を入力し「**次:フロントエンド IP 構成 >**」をクリックします。(指定のない項目は既定値のままにする)

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ（新規作成） | **az104-06-rg4** |
    | 名前 | **az104-06-lb4** |
    | 地域 | **East US** |
    | SKU | **Standard** |
    | 種類 | **パブリック** |
    
1. 「**フロントエンド IP の構成**」タブで、「**＋フロントエンド IP 構成の追加**」をクリックして、次の設定を入力し、「**追加**」をクリックします。   
   
    | 設定 | 値 |
    | --- | --- |
    | 名前                                                       | **LoadBalancerFrontEnd**  |
    | IPバージョン                                               | **IPv4**                  |
    | IPの種類                                                   | **IPアドレス**            |
    | **パブリックIPアドレス(新規作成)**：名前                   | **az104-06-pip4**         |
    | **パブリックIPアドレス(新規作成)**：可用性ゾーン | **ゾーン冗長** |
   | **パブリックIPアドレス(新規作成)**：ルーティングの優先順位 | **Microsoftネットワーク** |
   | ゲートウェイロードバランサー | **なし** |
   
1. 「**次:バックエンドプール >**」 をクリックし、「**バックエンドプールの追加**」をクリックします。

1. 次の設定でバックエンド プールを追加します (指定のない項目は既定値のままにする)。

    | 設定 | 値 |
    | --- | --- |
    | 名前                     | **az104-06-lb4-be1** |
    | 仮想ネットワーク         | **az104-06-vnet01**  |
    | バックエンドプールの構成 | **NIC**              |
    | IP構成           | **追加**           |
    | 仮想マシン               | **az104-06-vm0**     |
    | 仮想マシン               | **az104-06-vm1**     |

1. 「**保存**」 をクリックします。

1. 「**次:インバウンド規則 >**」 をクリックし、「**負荷分散規則の追加**」をクリックします。

1. 「**負荷分散規則の追加**」ブレードで、次の設定で負荷分散規則を追加します (指定のない項目は既定値のままにする)。

    | 設定                       | 値                       |
    | -------------------------- | ------------------------ |
    | 名前                       | **az104-06-lb4-lbrule1** |
    | IP バージョン              | **IPv4**                 |
    | フロントエンド IP アドレス | **LoadBalancerFrontEnd** |
    | バックエンド プール        | **az104-06-lb4-be1**     |
    | プロトコル                 | **TCP**                  |
    | ポート                     | **80**                   |
    | バックエンド ポート        | **80**                   |
    | 正常性プローブ(新規作成)   | **az104-06-lb4-hp1**     |
    | セッション永続化           | **なし**                 |
    | アイドル タイムアウト (分) | **4**                    |
    | TCP リセット               | **無効**                 |

    **※正常性プローブ(新規作成)**は以下の設定で追加してください。

    | 設定       | 値                   |
    | ---------- | -------------------- |
    | 名前       | **az104-06-lb4-hp1** |
    | プロトコル | **TCP**              |
    | ポート     | **80**               |
    | 間隔       | **5**                |

1. 「**保存**」 をクリックします

1. **「確認および作成」** をクリックし、**「作成」** をクリックします。

1. デプロイの完了後にリソースへ移動し、「**設定**」セクションの「**フロントエンドIP構成**」をクリックし、「**IP アドレス**」の値を記録します。

1. ブラウザで別のタブ、もしくはウィンドを開いて前の手順で識別した IP アドレスに移動します。

1. ブラウザー ウィンドウに、**「Hello World from az104-06-vm0」** または **「Hello World from az104-06-vm1」** というメッセージが

     表示されることを確認します。

1. 次に InPrivate モードのウィンドウを使用して、先ほどのIPアドレスに移動します。ターゲットVM(ページに表示されているVM名称)が変化しているかを確認します。

     > **注**: ウィンドウを更新するか、InPrivate モードを使用して再度開く必要があります。タイミングによっては同じVM名称が表示されます。

#### タスク 6: Azure Application Gateway を実装する

このタスクでは、スポーク仮想ネットワーク内の 2 つの Azure 仮想マシンの前に Azure Application Gateway を実装します。

1. Azure portal で、「**仮想ネットワーク**」 を検索して選択します。

1. 仮想ネットワークのリストで **「仮想ネットワーク」** ブレードで、**「az104-06-vnet01」** をクリックします。

1. **「az104-06-vnet01」** 仮想ネットワーク ブレードの **「設定」** セクションで、**「サブネット」** をクリックし、**「+ サブネット」** をクリックします。

1. 次の設定でサブネットを追加します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **subnet-appgw** |
    | サブネット アドレス範囲 | **10.60.3.224/27** |

1. 「**保存**」をクリックする

    > **注**: このサブネットは、このタスクの後半でデプロイする Azure Application Gateway インスタンスで使用されます。Application Gateway には、/27 以上のサイズの専用サブネットが必要です。

1. Azure portal で 「**アプリケーション ゲートウェイ**」 を検索して選択し、「**アプリケーション ゲートウェイ**」 ブレードで 「**+ 作成**」 をクリックします。

1. 「**アプリケーション ゲートウェイの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | **既定のサブスクリプション** |
    | リソース グループ（新規作成） | **az104-06-rg5** |
    | ゲートウェイ名 | **az104-06-appgw5** |
    | 地域 | **East US** |
    | レベル | **Standard V2** |
    | 自動スケール | **いいえ** |
    | HTTP2 | **Disabled** |
    | 仮想ネットワーク | **az104-06-vnet01** |
    | サブネット | **subnet-appgw** |

1. 「**次: フロントエンドの数 >**」 をクリックし、「**アプリケーション ゲートウェイの作成**」 ブレードの 「**フロントエンド**」 タブで、「**新規追加**」 をクリックして、次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | フロントエンド IP の種類 | **パブリック** |
    | パブリック IP アドレス(新規作成)  | **az104-06-pip5** |

1. 「**次: バックエンド >**」 をクリックし、「**アプリケーション ゲートウェイの作成**」 ブレードの 「**バックエンド**」 タブで、「**バックエンド プールの追加**」 をクリックし、「**バックエンド プールの追加**」 ブレードで、次の設定を指定します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前                                                | **az104-06-appgw5-be1**    |
    | ターゲットを持たないバックエンド プールを追加します | **いいえ**               |
    | ターゲットの種類                              | **IP アドレスまたは FQDN** |
    | ターゲット                                          | **10.62.0.4**              |
    | ターゲットの種類                               | **IP アドレスまたは FQDN** |
    | ターゲット                                          | **10.63.0.4**              |

    > **注**: ターゲットは、スポーク仮想ネットワーク **az104-06-vm2** および **az104-06-vm3** 内の仮想マシンのプライベート IP アドレスを表します。

1. 「**追加**」 をクリックし、「**次へ: 構成 >**」 をクリックし、「**+ ルーティング規則の追加**」 をクリックします。

1. 「**ルーティング規則の追加**」 ブレードの 「**リスナー**」 タブで、次の設定を指定します。

     | 設定 | 値 |
     | --- | --- |
     | ルール名          | **az104-06-appgw5-rl1**   |
     | 優先度 | **1** |
     | リスナー名        | **az104-06-appgw5-rl1l1** |
     | フロントエンド IP | **パブリック**           |
     | プロトコル        | **HTTP**                  |
     | ポート            | **80**                    |
     | リスナーの種類    | **Basic**                 |
     | エラー ページ の URL | **いいえ**                 |

1. 「**ルーティング規則の追加**」 ブレードの 「**バックエンド ターゲット**」 タブに切り替え、次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | ターゲット タイプ | **バックエンド プール** |
    | バックエンド ターゲット | **az104-06-appgw5-be1** |

1. 「**バックエンド設定**」 テキスト ボックスの下にある 「**新規追加**」 をクリックし、「**バックエンド 設定の追加**」 ブレードで次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | バックエンド 設定名          | **az104-06-appgw5-http1** |
    | バックエンド プロトコル     | **HTTP**                  |
    | バックエンド ポート         | **80**                    |
    | Cookie ベースのアフィニティ | **無効化**           |
    | 接続のドレイン               | **無効化**            |
    | 要求のタイムアウト (秒)    | **20**                    |

1. **「HTTP 設定の追加」** ブレードで **「追加」** をクリックし、**「ルーティング規則の追加**」 ブレードに戻って **「追加」** をクリックします。

1. **「次: タグ >**」 をクリックし、続いて 「**次: 確認および作成 >**」 をクリックし、**「作成」** をクリックします。

     > **注**: Application Gateway インスタンスが作成されるのを待ちます。8 分間程度かかる場合があります。

1. Azure portal で **「アプリケーション ゲートウェイ」** を検索して選択し、**「アプリケーション ゲートウェイ」** ブレードで **「az104-06-appgw5」** をクリックします。

1. **「az104-06-appgw5** Application Gateway」 ブレードで、**「フロントエンド パブリック IP アドレス」** の値を書き留めます。

1. 別のブラウザーのウィンドウを起動し、前の手順で識別した IP アドレスに移動します。

1. ブラウザー ウィンドウに、**「az104-06-vm2 から Hello World」** または **「az104-06-vm3 から Hello World」** というメッセージが表示されることを

     確認します。

1. 今度は InPrivate モードを使用して別のブラウザー ウィンドウを開き、Web ページに表示されるメッセージに基づいて、ターゲット VM が変更されたかどうかを確認します。

     > **注**: ブラウザー ウィンドウを更新するか、InPrivate モードを使用して再度開く必要があります。

     > **注**: 複数の仮想ネットワーク上の仮想マシンを対象とすることは一般的な構成ではありませんが、Application Gateway が複数の仮想ネットワーク上の仮想マシンや、他の Azureリージョンのエンドポイント、さらには Azure の外部のエンドポイントを対象とできる点を示すことを目的としています。同じ仮想ネットワーク内の仮想マシン間で負荷分散を行う Azure Load Balancer とは異なります。

#### 確認

このラボでは次の内容を学習しました。

+ ラボ環境をプロビジョニングしました
+ ハブとスポーク ネットワーク トポロジを構成しました
+ 仮想ネットワーク ピアリングの推移性をテストしました
+ タスク 4: ハブとスポークのトポロジのルーティングを構成する
+ タスク 5: Azure Load Balancer を実装する
+ タスク 6: Azure Application Gateway を実装する
